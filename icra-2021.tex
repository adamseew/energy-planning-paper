
%%
%% Conference Paper for ICRA'21, May 16-22, Xi'an, China
%% 
%%

\documentclass[letterpaper,10pt,conference]{ieeeconf}

\IEEEoverridecommandlockouts 

\newcommand{\stt}[1]{{\small\tt #1}} %\small\tt too small here
\newcommand{\powprof}{\stt{powprofiler}}
\newcommand{\figpath}{./figures}
\newcommand{\iu}{{i\mkern1mu}}
\let\labelindent\relax

\usepackage[inline]{enumitem}
\usepackage{booktabs}
\usepackage{flushend}
\usepackage{tikz}

%% citation packege
\usepackage{cite}

%% figures package
%\usepackage[pdftex]{graphicx}
%\graphicspath{{figures/}}
%\DeclareGraphicsExtensions{.pdf,.jpeg,.png}

%% math package
\usepackage[cmex10]{amsmath}
\usepackage{mathtools}
\usepackage{amssymb}
\usepackage{arydshln}
\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}

%% pseudocode package
%\usepackage{algorithmic}

%% packages for alignment
%\usepackage{array}
%\usepackage{mdwmath}
%\usepackage{mdwtab}
%\usepackage{eqparbox}

%% packages for subfigures (eventually)
\usepackage[tight,footnotesize]{subfigure}
%\usepackage[caption=false]{caption}
%\usepackage[font=footnotesize]{subfig}
%\usepackage[caption=false,font=footnotesize]{subfig}

%% package for urls
\usepackage{url}

\usepackage{textpos}

%% correct bad hyphenation here
\hyphenation{}

\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}[thm]{Lemma}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{assm}[thm]{Assumption}
\newtheorem{cor}{Corollary}
\newtheorem{conj}{Conjecture}[section]
\newtheorem{defn}{Definition}[section]
\newtheorem{exmp}{Example}[section]
\newtheorem{rem}{Remark}

%% references (generates a bib file for bibtex)
\begin{filecontents}{\jobname.bib}
  @inproceedings{seewald2020mechanical,
    title={Mechanical and Computational Energy Estimation of a Fixed-Wing Drone}, 
    author={Seewald, Adam and Garcia de Marina, Hector and Midtiby, Henrik Skov and Schultz, Ulrik Pagh},
    booktitle={2020 4th IEEE International Conference on Robotic Computing (IRC)},
    pages={to appear},
    year={2020},
    organization={IEEE},
    url={https://adamseew.bitbucket.io/short/mechanical2020}
  }
  @article{seewald2019coarse,
    title={Coarse-Grained Computation-Oriented Energy Modeling for Heterogeneous Parallel Embedded Systems},
    author={Seewald, Adam and Schultz, Ulrik Pagh and Ebeid, Emad and Midtiby, Henrik Skov},
    journal={International Journal of Parallel Programming},
    pages={1--22},
    year={2019},
    publisher={Springer}
  }
  @inproceedings{seewald2019component,
    title={Component-based computation-energy modeling for embedded systems},
    author={Seewald, Adam and Schultz, Ulrik Pagh and Roeder, Julius and Rouxel, Benjamin and Grelck, Clemens},
    booktitle={Proceedings Companion of the 2019 ACM SIGPLAN International Conference on Systems, Programming, Languages, and Applications: Software for Humanity},
    pages={5--6},
    year={2019},
    organization={ACM}
  }
  @inproceedings{boroujerdian2018compute,
    title={Why Compute Matters for UAV Energy Efficiency?},
    author={Boroujerdian, Behzad and Genc, Hasan and Krishnan, Srivatsan and Faust, Aleksandra and Reddi, Vijay Janapa},
    booktitle={2nd International Symposium on Aerial Robotics},
    year={2018}
  }
  @inproceedings{hajjaj2014review,
    title={Review of research in the area of agriculture mobile robots},
    author={Hajjaj, Sami Salama Hussen and Sahari, Khairul Salleh Mohamed},
    booktitle={The 8th International Conference on Robotic, Vision, Signal Processing \& Power Applications},
    pages={107--117},
    year={2014},
    organization={Springer}
  }
  @inproceedings{qingchun2012study,
    title={Study on strawberry robotic harvesting system},
    author={Qingchun, Feng and Wengang, Zheng and Quan, Qiu and Kai, Jiang and Rui, Guo},
    booktitle={2012 IEEE International Conference on Computer Science and Automation Engineering (CSAE)},
    volume={1},
    pages={320--324},
    year={2012},
    organization={IEEE}
  }
  @article{edan2000robotic,
    title={Robotic melon harvesting},
    author={Edan, Yael and Rogozin, Dima and Flash, Tamar and Miles, Gaines E},
    journal={IEEE Transactions on Robotics and Automation},
    volume={16},
    number={6},
    pages={831--835},
    year={2000},
    publisher={IEEE}
  }
  @inproceedings{aljanobi2010setup,
    title={A setup of mobile robotic unit for fruit harvesting},
    author={Aljanobi, AA and Al-Hamed, SA and Al-Suhaibani, SA},
    booktitle={19th International Workshop on Robotics in Alpe-Adria-Danube Region (RAAD 2010)},
    pages={105--108},
    year={2010},
    organization={IEEE}
  }
  @article{de2011design,
    title={Design and control of an apple harvesting robot},
    author={De-An, Zhao and Jidong, Lv and Wei, Ji and Ying, Zhang and Yu, Chen},
    journal={Biosystems engineering},
    volume={110},
    number={2},
    pages={112--122},
    year={2011},
    publisher={Elsevier}
  }
  @article{dong2011development,
    title={Development of a row guidance system for an autonomous robot for white asparagus harvesting},
    author={Dong, Fuhong and Heinemann, Wolfgang and Kasper, Roland},
    journal={Computers and Electronics in Agriculture},
    volume={79},
    number={2},
    pages={216--225},
    year={2011},
    publisher={Elsevier}
  }
  @inproceedings{li2008analysis,
    title={Analysis of workspace and kinematics for a tomato harvesting robot},
    author={Li, Zhiguo and Liu, Jizhan and Li, Pingping and Li, Wei},
    booktitle={2008 International Conference on Intelligent Computation Technology and Automation (ICICTA)},
    volume={1},
    pages={823--827},
    year={2008},
    organization={IEEE}
  }
  @article{puri2017agriculture,
    title={Agriculture drones: A modern breakthrough in precision agriculture},
    author={Puri, Vikram and Nayyar, Anand and Raja, Linesh},
    journal={Journal of Statistics and Management Systems},
    volume={20},
    number={4},
    pages={507--518},
    year={2017},
    publisher={Taylor \& Francis}
  }
  @inproceedings{mei2005case,
    title={A case study of mobile robot's energy consumption and conservation techniques},
    author={Mei, Yongguo and Lu, Yung-Hsiang and Hu, Y Charlie and Lee, CS George},
    booktitle={ICAR'05. Proceedings., 12th International Conference on Advanced Robotics, 2005.},
    pages={492--497},
    year={2005},
    organization={IEEE}
  }
  @inproceedings{mei2004energy,
    title={Energy-efficient motion planning for mobile robots},
    author={Mei, Yongguo and Lu, Yung-Hsiang and Hu, Y Charlie and Lee, CS George},
    booktitle={IEEE International Conference on Robotics and Automation, 2004. Proceedings. ICRA'04. 2004},
    volume={5},
    pages={4344--4349},
    year={2004},
    organization={IEEE}
  }
  @article{mei2006deployment,
    title={Deployment of mobile robots with energy and timing constraints},
    author={Mei, Yongguo and Lu, Yung-Hsiang and Hu, Yu Charlie and Lee, CS George},
    journal={IEEE Transactions on robotics},
    volume={22},
    number={3},
    pages={507--522},
    year={2006},
    publisher={IEEE}
  }
  @inproceedings{uragun2011energy,
    title={Energy efficiency for unmanned aerial vehicles},
    author={Uragun, Balemir},
    booktitle={2011 10th International Conference on Machine Learning and Applications and Workshops},
    volume={2},
    pages={316--320},
    year={2011},
    organization={IEEE}
  }
  @inproceedings{kreciglowa2017energy,
    title={Energy efficiency of trajectory generation methods for stop-and-go aerial robot navigation},
    author={Kreciglowa, Nadia and Karydis, Konstantinos and Kumar, Vijay},
    booktitle={2017 International Conference on Unmanned Aircraft Systems (ICUAS)},
    pages={656--662},
    year={2017},
    organization={IEEE}
  }
  @article{kanellakis2017survey,
    title={Survey on computer vision for UAVs: Current developments and trends},
    author={Kanellakis, Christoforos and Nikolakopoulos, George},
    journal={Journal of Intelligent \& Robotic Systems},
    volume={87},
    number={1},
    pages={141--168},
    year={2017},
    publisher={Springer}
  }
  @article{sadrpour2013mission,
    title={Mission Energy Prediction for Unmanned Ground Vehicles Using Real-time Measurements and Prior Knowledge},
    author={Sadrpour, Amir and Jin, Jionghua and Ulsoy, A Galip},
    journal={Journal of Field Robotics},
    volume={30},
    number={3},
    pages={399--414},
    year={2013},
    publisher={Wiley Online Library}
  }
  @inproceedings{sadrpour2013experimental,
    title={Experimental validation of mission energy prediction model for unmanned ground vehicles},
    author={Sadrpour, Amir and Jin, Judy and Ulsoy, A Galip},
    booktitle={2013 American Control Conference},
    pages={5960--5965},
    year={2013},
    organization={IEEE}
  }
  @article{berenz2012autonomous,
    title={Autonomous battery management for mobile robots based on risk and gain assessment},
    author={Berenz, Vincent and Tanaka, Fumihide and Suzuki, Kenji},
    journal={Artificial Intelligence Review},
    volume={37},
    number={3},
    pages={217--237},
    year={2012},
    publisher={Springer}
  }
  @inproceedings{kim2005energy,
    title={Energy-saving 3-step velocity control algorithm for battery-powered wheeled mobile robots},
    author={Kim, Chong Hui and Kim, Byung Kook},
    booktitle={Proceedings of the 2005 IEEE international conference on robotics and automation},
    pages={2375--2380},
    year={2005},
    organization={IEEE}
  }
  @inproceedings{kim2008minimum,
    title={Minimum-energy translational trajectory planning for battery-powered three-wheeled omni-directional mobile robots},
    author={Kim, Hongjun and Kim, Byung-Kook},
    booktitle={2008 10th International Conference on Control, Automation, Robotics and Vision},
    pages={1730--1735},
    year={2008},
    organization={IEEE}
  }
  @article{morales2009power,
    title={Power consumption modeling of skid-steer tracked mobile robots on rigid terrain},
    author={Morales, Jesus and Martinez, Jorge L and Mandow, Anthony and Garc{\'\i}a-Cerezo, Alfonso J and Pedraza, Salvador},
    journal={IEEE Transactions on Robotics},
    volume={25},
    number={5},
    pages={1098--1108},
    year={2009},
    publisher={IEEE}
  }
  @book{wahab2015energy,
    title={Energy modeling of differential drive robots},
    author={Wahab, Mudasser and Rios-Gutierrez, Fernando and El Shahat, Adel},
    year={2015},
    publisher={IEEE}
  }
  @article{rao2003battery,
    title={Battery modeling for energy aware system design},
    author={Rao, Ravishankar and Vrudhula, Sarma and Rakhmatov, Daler},
    journal={Computer},
    volume={36},
    number={12},
    pages={77--87},
    year={2003},
    publisher={IEEE}
  }
  @inproceedings{chiasson2003estimating,
    title={Estimating the state of charge of a battery},
    author={Chiasson, John and Vairamohan, Baskar},
    booktitle={Proceedings of the 2003 American Control Conference, 2003.},
    volume={4},
    pages={2863--2868},
    year={2003},
    organization={IEEE}
  }
  @inproceedings{pang2001battery,
    title={Battery state-of-charge estimation},
    author={Pang, Shuo and Farrell, Jay and Du, Jie and Barth, Matthew},
    booktitle={Proceedings of the 2001 American control conference.(Cat. No. 01CH37148)},
    volume={2},
    pages={1644--1649},
    year={2001},
    organization={IEEE}
  }
  @article{partovibakhsh2014adaptive,
    title={An adaptive unscented Kalman filtering approach for online estimation of model parameters and state-of-charge of lithium-ion batteries for autonomous mobile robots},
    author={Partovibakhsh, Maral and Liu, Guangjun},
    journal={IEEE Transactions on Control Systems Technology},
    volume={23},
    number={1},
    pages={357--363},
    year={2014},
    publisher={IEEE}
  }
  @inproceedings{zhang2009battery,
    title={Battery state estimation using unscented kalman filter},
    author={Zhang, Fei and Liu, Guangjun and Fang, Lijin},
    booktitle={2009 IEEE International Conference on Robotics and Automation},
    pages={1863--1868},
    year={2009},
    organization={IEEE}
  }
  @inproceedings{hasan2018exogenous,
    title={Exogenous kalman filter for state-of-charge estimation in lithium-ion batteries},
    author={Hasan, Agus and Skriver, Martin and Johansen, Tor Arne},
    booktitle={2018 IEEE Conference on Control Technology and Applications (CCTA)},
    pages={1403--1408},
    year={2018},
    organization={IEEE}
  }
  @inproceedings{nardi2015introducing,
    title={Introducing SLAMBench, a performance and accuracy benchmarking methodology for SLAM},
    author={Nardi, Luigi and Bodin, Bruno and Zia, M Zeeshan and Mawer, John and Nisbet, Andy and Kelly, Paul HJ and Davison, Andrew J and Luj{\'a}n, Mikel and O'Boyle, Michael FP and Riley, Graham and others},
    booktitle={2015 IEEE International Conference on Robotics and Automation (ICRA)},
    pages={5783--5790},
    year={2015},
    organization={IEEE}
  }
  @online{px4,
    author={PX4},
    title={{PX4} open-source autopilot},
    url={https://px4.io/},
    urldate={2016-09-01}
  }
  @online{papa,
    author={Paparazzi},
    title={{UAV} open-source project},
    url={http://wiki.paparazziuav.org/},
    urldate={2016-09-01}
  }
  @online{nano,
    author={NVIDIA},
    title={{NVIDIA Jetson Nano} developer kit},
    url={https://developer.nvidia.com/embedded/jetson-nano-developer-kit},
    urldate={2020-02-02}
  }
  @online{opterra,
    author={Horizon Hobby},
    title={{Opterra} 2m Wing BNF Basic},
    url={https://www.horizonhobby.com/opterra-2m-wing-bnf-basic-p-efl11150},
    urldate={2020-02-02}
  }
  @online{meier2013mavlink,
    title={Mavlink: Micro air vehicle communication protocol},
    author={Meier, Lorenz and Camacho, J and Godbolt, B and Goppert, J and Heng, L and Lizarraga, M and others},
    url={https://mavlink.io/},
    urldate={2020-02-02}
  }
  https://mavlink.io/
  @article{ullah2018pednet,
    title={Pednet: A spatio-temporal deep convolutional neural network for pedestrian segmentation},
    author={Ullah, Mohib and Mohammed, Ahmed and Alaya Cheikh, Faouzi},
    journal={Journal of Imaging},
    volume={4},
    number={9},
    pages={107},
    year={2018},
    publisher={Multidisciplinary Digital Publishing Institute}
  }
  @inproceedings{sandler2018mobilenetv2,
    title={Mobilenetv2: Inverted residuals and linear bottlenecks},
    author={Sandler, Mark and Howard, Andrew and Zhu, Menglong and Zhmoginov, Andrey and Chen, Liang-Chieh},
    booktitle={Proceedings of the IEEE conference on computer vision and pattern recognition},
    pages={4510--4520},
    year={2018}
  }
  @inproceedings{quigley2009ros,
    title={ROS: an open-source Robot Operating System},
    author={Quigley, Morgan and Conley, Ken and Gerkey, Brian and Faust, Josh and Foote, Tully and Leibs, Jeremy and Wheeler, Rob and Ng, Andrew Y},
    booktitle={ICRA workshop on open source software},
    volume={3},
    number={3.2},
    pages={5},
    year={2009}
  }
  @book{stengel1994optimal,
    title={Optimal control and estimation},
    author={Stengel, Robert F},
    year={1994},
    publisher={Courier Corporation}
  }
  @book{simon2006optimal,
    title={Optimal state estimation: Kalman, H infinity, and nonlinear approaches},
    author={Simon, Dan},
    year={2006},
    publisher={John Wiley \& Sons}
  }
  @inproceedings{de2017guidance,
    title={Guidance algorithm for smooth trajectory tracking of a fixed wing UAV flying in wind flows},
    author={De Marina, Hector Garcia and Kapitanyuk, Yuri A and Bronz, Murat and Hattenberger, Gautier and Cao, Ming},
    booktitle={2017 IEEE international conference on robotics and automation (ICRA)},
    pages={5740--5745},
    year={2017},
    organization={IEEE}
  }
  @book{rawlings2017model,
    title={Model predictive control: theory, computation, and design},
    author={Rawlings, James Blake and Mayne, David Q and Diehl, Moritz},
    volume={2},
    year={2017},
    publisher={Nob Hill Publishing Madison, WI}
  }
  @inproceedings{morbidi2016minimum,
    title={Minimum-energy path generation for a quadrotor UAV},
    author={Morbidi, Fabio and Cano, Roel and Lara, David},
    booktitle={2016 IEEE International Conference on Robotics and Automation (ICRA)},
    pages={1492--1498},
    year={2016},
    organization={IEEE}
  }
  @inproceedings{daponte2019review,
    title={A review on the use of drones for precision agriculture},
    author={Daponte, Pasquale and De Vito, Luca and Glielmo, Luigi and Iannelli, Luigi and Liuzza, Davide and Picariello, Francesco and Silano, Giuseppe},
    booktitle={IOP Conference Series: Earth and Environmental Science},
    volume={275},
    number={1},
    pages={012022},
    year={2019},
    organization={IOP Publishing}
  }

\end{filecontents}

\title{\LARGE \bf
***
}

%% author names and affiliations
\author{
  Adam Seewald$^{1}$, Hector Garcia de Marina$^{2}$, and Ulrik Pagh Schultz$^{1}$
  \thanks{This work is supported and partly funded by the European Union's Horizon2020 research and innovation program under grant agreement No. 779882 (TeamPlay).
  }
  \thanks{$^{1}$Adam Seewald, Ulrik Pagh Schultz are with the SDU UAS Center, M{\ae}rsk Mc-Kinney M{\o}ller Institute, University of Southern Denmark, Odense, Denmark. Email: {\tt\small ads@mmmi.sdu.dk}.}
  \thanks{$^{2}$Hector Garcia de Marina is with the Faculty of Physics, Department of Computer Architecture and Automatic Control, Universidad Computense de Madrid, Spain.}
}

\begin{document}

%% make the title area
\maketitle

\thispagestyle{empty}
\pagestyle{empty}

\begin{abstract}

  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract
\end{abstract}

% For peer review papers, you can put extra information on the cover
% page as needed:
% \ifCLASSOPTIONpeerreview
% \begin{center} \bfseries EDICS Category: 3-BBND \end{center}
% \fi
%
% For peerreview papers, this IEEEtran command inserts a page break and
% creates the second title. It will be ignored for other modes.
\IEEEpeerreviewmaketitle


%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
\label{sec:intro}

% what I want to do with words.
% diggested version of the technical details
% strory goes to the introduction
% depends
% big picture in the introduction to agree what specifically I am trying to do right now

Precision agriculture is rising in demand for reducing waste, costs, and resources while increasing outputs and utilization~\cite{hajjaj2014review}. Researchers have fulfilled some of these demands applying mobile robots in agricultural scenarios such as harvesting~\cite{qingchun2012study,dong2011development, de2011design, aljanobi2010setup, li2008analysis, edan2000robotic}, where complex monitoring strategies--often implemented utilizing unmanned aerial vehicles (UAVs)--are usually required for preventing damage and ensuring better crop quality~\cite{puri2017agriculture}. Planning a mission for UAVs operating in such scenarios is a challenging task. It usually requires advanced levels of autonomy, with the UAV being, e.g., used to inform its grounded counterparts of obstacles detected while flying, along with strictly limited energy budgets. Currently, UAVs in precision agriculture are semi-autonomous, in the sense that the path is static and defined using a mission planning software~\cite{daponte2019review}. The presented approach proposes an \emph{energy-aware dynamic mission planning algorithm} for UAVs for precision agriculture that addresses the broader problem of increasing \emph{computational demands} and their relation to the UAV's energy consumption, path, and autonomy.

Although underrepresented in precision agriculture literature, energy planning algorithms for mobile robots are not a new concept and have been extensively studied, being these correlated to such topics as trajectory generation and path planning. Generally, they account for the energy due to the trajectory, by e.g., maximizing the operation time~\cite{wahab2015energy}, but practically restrict to a narrow class of mobile robots~\cite{kim2005energy}, and focus on optimizing motion control for such robots~\cite{kim2008minimum}. In a similar setting, rotorcrafts have been an obvious object of research interest, with such approaches as the energy-efficient trajectory generation~\cite{morbidi2016minimum,kreciglowa2017energy}. Conversely, the presented approach attempts to combine and generalize some of these technical breakthroughs and correlate the extensively studied energy planning to the growing computational demands of precision agriculture UAVs through a mission-aware perspective.
Of particular inspiration to the approach is the technique of coupling the energy due to the computations performed and trajectory traveled, although being, likewise the others, limited to the trajectory in Mei.~et.~al.~\cite{mei2004energy,mei2005case,mei2006deployment}, or to the class of mobile robots in Sadrpour.~et.~al.~\cite{sadrpour2013mission,sadrpour2013experimental}.

The algorithm accounts for the energy due to the path similarly to Met~et.~al. but includes the computations in a broad mission planning setting, like the one in Sadrpour~et.~al. It adapts the energy dynamically, defining mission-specific parameters: the Quality of Service (QoS) of the onboard computations, and the trajectory-explicit equations (TEEs) of the path. It ideally accounts for a mission extension by adapting both QoS and TEEs as the UAV flyes and its batteries drain. Firstly, the algorithm adapts QoS requiring the UAV to comprise robot operating system (ROS) with computationally expensive ROS nodes controlled through ROS parameters. Secondly, it adapts TEEs--a mathematical abstraction of the path to follow--and implements the change updating a vector field that converges smoothly to such path. Physically, one can use a feature detection node and a set of ellipses, with the algorithm controlling the processing rate and the length of the semi-major and -minor axis. Data using a fixed-wing UAV indicates a potential extension of up to 13 minutes over an hour by merely switching to the lowest QoS.

The algorithm relies on the assumptions of the mission--a time-varying path and a set of tasks the UAV is supposed to perform along the TEEs and QoS parameters constraints--being \emph{periodic} and \emph{uncertain}. The periodicity is directly observed, by e.g., the UAV flying in repetitive patterns, and the uncertainty accounts for the environmental interference with e.g., a fixed-wing UAV drifting due to windy weather. We propose the Fourier analysis to address the periodicity assumption--being the mission periodic, we expect the energy to evolve also periodically--and a state estimator to cope with the uncertainty assumption. The algorithm selects the controls (QoS and TEEs) dynamically using a modified tube-based output model predictive control (MPC), ensuring that state estimation error does not result in transgression of the control and state constraints.  

The remainder of the paper is organized as follows. A suitable energy model for the path and the computations is showed in Section~\ref{sec:model}. The algorithm that uses the energy model to address dynamic mission planning is proposed in Section~\ref{sec:algo}. Section~\ref{sec:experimental} presents a fixed-wing UAV flying in an agricultural scenario showcasing the performance. The paper finishes with some conclusions in Section~\ref{sec:conclusion}.


%%%%%%%%%%%%%%%
\section{Model}
\label{sec:model}

The algorithm utilizes the model to estimate the robot's position in space and its energy evolution in time.

Starting with a position $\mathbf{p}\in\mathbb{R}^3$ in the 3D Euclidean space, with respect to some inertial navigation frame $\mathcal{O}_W$, a guidance action--which allows the motion along the 3-axis--is built upon the direction to follow and derived using vector field~\cite{de2017guidance}. To define the direction to follow, we use generic continuously differentiable functions TEEs $\varphi:\mathbb{R}^3\rightarrow\mathbb{R}$, a mathematical abstraction representing the desired trajectory (being the function satisfied $\varphi(\mathbf{p})\rightarrow 0$ for all the points approaching such trajectory).

The energy evolution $\mathbf{q}\in\mathbb{R}^j$ spent to perform such guidance action is derived using Fourier analysis (the meaning of $j$ will be explained to the reader in Subsection~\ref{sec:energy-model}) and is decomposed in the energy due to the trajectory (TEEs), and the computations (QoS)--an approach that has been adapted from authors' earlier work on computational energy analysis~\cite{seewald2019coarse, seewald2019component}, and energy estimation of a fixed-wing craft~\cite{seewald2020mechanical}.

\subsection{Position in space and guidance action}
\label{sec:position}

For exemplification, we consider a non-holonomic 2D model of a fixed-wing craft flying at an assigned altitude $h\in\mathbb{R}_{>0}$. We will show, after the results, the requirement being eased to an arbitrary mobile robot model
\begin{equation}\label{eq:uav-kinem}\begin{cases}
  \dot{\mathbf{p}}(t)&=s\Psi(\psi(t))+d(t)\\
  \dot{\psi}(t)&=u(\mathbf{p}(t))
\end{cases},
\end{equation}
where $\mathbf{p}(t)\in\mathbb{R}^2$, $s\in\mathbb{R}$ describes the airspeed assumed constant, $\psi(t)\in(-\pi,\pi]$ the attitude yaw angle and $\Psi(\psi(t))=\begin{bmatrix}\cos{\psi(t)} & \sin{\psi(t)}\end{bmatrix}^T$, $d$ is the wind vector where we assume $\|d\|<s$, and $u\in\mathbb{R}$ the guidance action which denotes the angular velocity $\dot{\psi}$ of the craft.

Let us define $\mathcal{P}$ the area which discloses all the possible paths within the boundaries $\underline{c}\in\mathbb{R}_{\leq 0},\overline{c}\in\mathbb{R}_{\geq 0}$
\begin{equation}\label{eq:area}
  \mathcal{P}:=\{\mathbf{p}:\underline{c}\leq\varphi(\mathbf{p})\leq\overline{c}\},
\end{equation}
where $\underline{a},\overline{a}$ returns the upper bound and lower bound limit of $a$ from the mission specification, which is a lookup table.

The concept of area between the bounds is used later to design a controller that selects $c$ with the highest energy value under the energy budget constraints. Here we design a guidance action $u$ that allows following $\varphi$ in such area by the means of minimizing the norm $\|\varphi(\mathbf{p})\|$.

Let us define $\varPhi:=\varphi(\mathbf{p})$. The direction to follow is expressed as the desired velocity vector
\begin{equation}\label{eq:pd}
  \dot{\mathbf{p}}_d(\mathbf{p}):=E\nabla\varPhi-k_e\varPhi\nabla\varPhi,\,\,\,E=\begin{bmatrix}
    0&1\\-1&0
  \end{bmatrix},
\end{equation}
where $\nabla\varPhi\in\mathbb{R}^2$ is defined as the gradient of $\varphi$ at the point $\mathbf{p}$ (i.e., its vector field), $E$ specifies the tracking direction, and $k_e\in\mathbb{R}_{\geq 0}$ the gain which adjusts the speed of convergence.

The direction the velocity vector $\dot{\mathbf{p}}$ is pointing at is generally different from the course heading $\chi\in(-\pi,\pi]$ due to the atmospheric interference.

Let us further define $\hat{\mathbf{p}}:=\mathbf{p}/\|\mathbf{p}\|$, the desired course heading rate $\dot{\chi_d}$ is computed by sensing the position $\mathbf{p}$, the ground velocity $\dot{\mathbf{p}}$, and is expressed
\begin{equation}\label{eq:chid}\begin{split}
  &\dot{\chi}_d(\mathbf{p})=-E\frac{\dot{\mathbf{p}}_d}{\|\dot{\mathbf{p}}_d\|^2}\cdot\\
  &\hspace{2ex}\left( E\hat{\dot{\mathbf{p}}}_d\hat{\dot{\mathbf{p}}}_d^TE\left( (E-k_e\varPhi)H(\varPhi)\dot{\mathbf{p}}-k_e\nabla\varPhi^T\dot{\mathbf{p}}\nabla\varPhi \right) \right)^T,
\end{split}
\end{equation} 
where $H(\cdot)$ is defined as the Hessian operator; the physical meaning is that the curvature of the desired trajectory has to be known in order to be tracked.

Under the assumption of the airspeed $s>\|w(t)\|$ for $t>0$ (i.e., the constant airspeed is greater than the norm of the wind), the guidance action can be expressed
\begin{equation}\label{eq:uav-cont}
  u(\mathbf{p},\psi)=\frac{\|\dot{\mathbf{p}}\|}{s\cos{\gamma}}\left( \dot{\mathbf{\chi}}_d(\mathbf{p})+k_d\hat{\dot{\mathbf{p}}}^TE\hat{\dot{\mathbf{p}}}_d \right),
\end{equation} 
where $k_d\in\mathbb{R}_{\geq 0}$ is the gain which adjusts the speed of the convergence of $\dot{\mathbf{p}}_d$, $\gamma=\cos^{-1}{\left( \hat{\dot{\mathbf{p}}}^T\Psi(\psi) \right)}$ is the sideslip angle, and $\dot{\chi}_d$ is given in Equation~(\ref{eq:chid}).

\subsection{Energy evolution due to trajectory}
\label{sec:energy-model}

To evaluate the energy we formalize the following realistic assumption introduced in Section~\ref{sec:intro}.
\begin{assm}\label{assm:periodic}
The mission the mobile robots perform is periodic, in the sense that it presents repetitive patterns.
\end{assm}

Let us consider a Fourier series $f:\mathbb{R}_{\geq 0}\rightarrow\mathbb{R}_{\geq 0}$ of an arbitrary order $r\in\mathbb{Z}_{\geq 0}$
\begin{equation}\label{eq:fourier}
  f(t)=\sum_{n=0}^{r}{a_n\cos{\frac{nt}{\xi}}+b_n\sin{\frac{nt}{\xi}}},
\end{equation}
where $\xi\in\mathbb{R}$ is the characteristic time, and $a_n, b_n\in\mathbb{R}$ for $n\in\{0,\dotsc,r\}$ the Fourier series coefficients.

The non-linear model in Equation~(\ref{eq:fourier}) can be expressed using an equivalent time-varying state-space model in the following form
\begin{equation}\label{eq:state-perf}\begin{cases}
  \dot{\mathbf{q}}(t)&=A\mathbf{q}(t)+B\mathbf{u}(t)\\%+w(t)\\
  y(t)&=C\mathbf{q}(t)%+v(t)
\end{cases},\end{equation}
where $y(t)\in\mathbb{R}_{\geq 0}$ is the instantaneous energy evolution of the system being controlled. We will see later in the Theorem~\ref{thm:state-vs-energy} that the instantaneous energy can be obtained from the model as a linear combination of the state. The control $\mathbf{u}$ along with the input matrix $B$ are defined later in Subsection~\ref{sec:control-action}, the state $\mathbf{q}$ mimics the original Fourier series coefficients, and
\begin{equation}\label{eq:state-details}\begin{split}
  \mathbf{q}(t)&=\left[\begin{array}{ccccccc}
    \alpha_0 & \vline & \alpha_1 & \beta_1 & \cdots & \alpha_r & \beta_r
  \end{array}\right]^T,\\
  A&=\left[\begin{array}{ccccc}
    1          & \vline & \mathbf{0} & \cdots & \mathbf{0} \\\hline
    \mathbf{0} & \vline & A_1        & \cdots & \mathbf{0} \\
    \vdots     & \vline & \vdots     & \ddots & \vdots     \\
    \mathbf{0} & \vline & \mathbf{0} & \cdots & A_r 
  \end{array}\right],\,A_n=\begin{bmatrix}0 & \frac{n}{\xi} \\ -\frac{n^2}{\xi^2} & 0\end{bmatrix},\\
  C&=\left[\begin{array}{ccccccc}
    1 & \vline & 1 & 0 & \cdots & 1 & 0
  \end{array}\right],
\end{split}\end{equation}
where $\mathbf{q}(t)\in\mathbb{R}^j$ given $j:=2r+1$, $A\in\mathbb{R}^{j\times j}$ is the state transmission matrix, and $C\in\mathbb{R}^j$ is the output matrix. Furthermore, the first row and column of the matrix $A$ contain zeros row vectors and column vectors respectively.

Motivated by the fact that the system of interest is sampled discrete-time, we consider the discretized version of Equation~(\ref{eq:state-perf}) and add the uncertainty
\begin{equation}\label{eq:state-unct}
  \begin{cases}
  \mathbf{q}_{k+1}&=A\mathbf{q}_{k}+B\mathbf{u}_{k}+w_k\\
  y_k&=C\mathbf{q}_k+v_k
  \end{cases},
\end{equation}
where $w_k\in\mathbb{R}$ accounts for the environment uncertainty, and $v_k\in\mathbb{R}$ for the measurement error.

The instantaneous energy can be obtained from the model~(\ref{eq:state-unct}) as a linear combination of the state.

\begin{lem}\label{lem:state-vs-energy}
  Suppose the system behaves ideally (with no environment uncertainty and measurement error).
  The magnitude of two arbitrary states $\mathbf{q}_{k,0},\mathbf{q}_{k,1}$ described in~(\ref{eq:state-details}) along their evolution~(\ref{eq:state-unct}) at time instant $k$ depends on the instantaneous energy consumption
  \begin{equation}
    \|\mathbf{q}_{k,0}\|\geq\|\mathbf{q}_{k,1}\|\iff y_{k,0}\geq y_{k,1}.
  \end{equation}
\end{lem}
\begin{proof}
  *\\
\end{proof}

\subsection{Energy evolution due to computations}
\label{sec:computations-model}

A computational energy model is built using \powprof{}, an open-source modeling tool that measures empirically software configurations and builds an energy model, presented in authors' previous work~\cite{seewald2019coarse}. Specifically, the tool builds a multivariate linear interpolation which is accessed online at the hand of a lookup table in the optimal control algorithm. The system is modeled as follows. An existing ROS system composes several computationally expensive ROS nodes, allowing to vary the number of computations changing some node-specific quality of service (QoS) values via ROS parameters. The tool builds the energy model using mission specification which, besides other mission parameters, specifies per each ROS node a QoS range.

Suppose the system is composed of $\sigma$ computationally expensive ROS nodes. Let us define the computational control action
\begin{equation}\label{eq:qos-def}
  \mathcal{C}_k:=\left\{u:u\in\text{QoS}_n(k)\,\forall\,n\in\{0,\dots,\sigma-1\}\right\},
\end{equation}
where $\text{QoS}_n(t):\mathbb{Z}_{\geq 0}\rightarrow\mathbb{Z}_{\geq 0}$ returns the $n$-th QoS value at time $t$, and $\mathcal{C}_k\in\mathbb{Z}_{\geq 0}^\sigma$ the set of $\sigma$ QoS values the system is composed of at time $k$. Let us further define $g:\mathbb{Z}_{\geq 0}\times\mathbb{Z}_{\geq 0}\rightarrow\mathbb{R}_{\geq 0}$ as the instantaneous energy value obtained interrogating \powprof{}. The instantaneous computational energy component can be defined
\begin{equation}\label{eq:energy-comp}\begin{split}
  y_k^c:&=g\left(\text{QoS}_0\left(k\right),\dots,\text{QoS}_{\sigma-1}\left(k\right)\right)=g\left(\mathcal{C}_{k}\right).\\
\end{split}\end{equation}

The QoS parameters $\mathcal{C}_k$ can be subject to different constraints at different states. Physically, this means that the robot can perform the ROS nodes within different QoS ranges while flying different phases of a mission
\begin{equation}\label{eq:qos-lims}\begin{split}
  \underline{\text{QoS}}_n(k)\leq \,&\text{QoS}_n(k)\leq \overline{\text{QoS}}_n(k),\\
  &\forall n\in\{0,\cdots,\sigma-1\},
\end{split}\end{equation}
where the values $\underline{\text{QoS}}_n(k),\overline{\text{QoS}}_n(k)$ are retrieved from the mission specification.

The control action is built in two steps. Equation~(\ref{eq:qos-def}) defines the control due to the computations. The control due to the trajectory is specific to the system being analyzed, for instance on the model of the fixed-wing craft in~(\ref{eq:uav-kinem}), along its control in Equation~(\ref{eq:chid})~and~(\ref{eq:uav-cont}). A generalization which accounts for the variations in the TEE $\varphi$ of a generic model by means of the TEEs parameters is derived in the following subsection.

\subsection{Control action}
\label{sec:control-action}

Given a generic trajectory equation $\varphi$, the trajectory can be modeled by $\rho$ TEE parameters $\mathcal{M}\in\mathbb{R}^\rho$, e.g., the constants of a linear function, the radius of a circle, and semi-major and minor axis of an ellipse. Let us define $\mathbf{u}_{k,n}:=\{u_{k,0},\dots,u_{k,n-1},u_{k,n}^0,u_{k,n+1},\dots,u_{k,\rho_k-1}\}$, the set of these parameters can be expressed
\begin{equation}\label{eq:tee-def}\begin{split}
  \mathcal{M}_k:=\{u_{k,n} : \,
  &\varphi_k(\mathbf{p}_{k,n}^0,\mathbf{u}_{k,n})\in\mathcal{P}\\
  &\forall n\in\{0,\dots,\rho_k-1\}\},
\end{split}\end{equation}
where $\mathbf{p}_k^0$ is any optimal point which let the trajectory explicit function $\varphi_k$ converge under any optimal TEE parameter $u_k^0$. Physically $\mathcal{M}_k$ contains all the controls generating the points over the area $\mathcal{P}$ defined in Equation~(\ref{eq:area}). 

The explicit trajectory equation $\varphi_k$ can be different at different states $k$, meaning the vector field and guidance action, from Equation~(\ref{eq:pd})~and~(\ref{eq:uav-cont}) respectively, will account for the sudden change of trajectory during the mission.

It is worth considering that the number of parameters at state $k$ is a parameter of the state. This is for the sake of generality, as the mission specification might contain different explicit equations for different states. For instance, the fixed-wing craft might follow an ellipse function throughout the mission and heading a linear function while landing. 

The TEE parameters and QoS, $\mathcal{M}$ and $\mathcal{C}$ defined in Equation~(\ref{eq:tee-def})~and~(\ref{eq:qos-def}), are incorporated in the system in Equation~(\ref{eq:state-unct}) using the input matrix
\begin{equation}
  \mathbf{u}_k=\left[\begin{array}{c}
    g\left(\mathcal{C}_k\right) \\\hline \mathcal{M}_k
  \end{array}\right],\,\,\,
  B=\left[\begin{array}{ccccccc}
    1 & \vline & 0 & \cdots & 0\\\hline
    0 & \vline & 0 & \cdots & 0\\
    \vdots & \vline & \vdots & \ddots & \vdots\\
    0 & \vline & 0 & \cdots & 0
  \end{array}\right],
\end{equation}
where $\mathbf{u}_k\in\mathbb{R}^l$ is the control given $l:=1+\rho$, and $B\in\mathbb{R}^{j\times l}$ is the input matrix from Equation~(\ref{eq:state-perf})~and~(\ref{eq:state-unct}). Moreover, the first column in the first row of the input matrix is $1$, while all the other items are $0$. This adds the computational model component to the energy evolution in the system. The energy due to the change of explicit trajectory equation parameters is not directly added to the system, which however will update the reading from the sensors $y^s$ defined in Subsection~\ref{sec:state-est} and adjust the energy evolution accordingly.

\section{Algorithm}
\label{sec:algo}

The main goal of the algorithm is to find an optimal control action $\mathbf{u}^0$ for the current state $\hat{\mathbf{q}}$--estimated from sensors' measurements--from the optimal control law $\mathbf{u}^0=:\kappa(\hat{\mathbf{q}})$. This is achieved by solving online a finite horizon optimal control problem by the hand of a modification of a model predictive control (MPC) algorithm~\cite{rawlings2017model}.

Let us proof formally an important finding from Section~\ref{sec:model} extensively used in the algorithm.

% [Ad:] I am actually not entirely sure if the thm should be here (and if it makes sense). Aka proving formally that what we do is actually what we expect; so perhaps it does make sense but I would like your opinion before spending time on the demonstrations... Same for the lemma.
% [Ad:] And here I had the doubt if to place the thm just straight after the lemma or here. I places it here as this is actually the main contribution -> the energy model working. Does it make any sense?

\begin{thm}\label{thm:state-vs-energy}
  Consider a continuously differentiable function $\varphi_k:\mathbb{R}^3\rightarrow\mathbb{R}$ at a time instant $k\in\mathbb{Z}_{>0}$.
  Assume Assumption~\ref{assm:periodic} holds, the robots is free to move in $\mathcal{P}$ defined in~(\ref{eq:area}), and is following $\varphi$ with the direction $\hat{\mathbf{p}}_d$ defined in~\ref{eq:pd}. Likewise in Lemma~\ref{lem:state-vs-energy}, the model behaves ideally. 
  Then, the instantaneous energy consumption is a linear combination of the state
  \begin{equation}
    y_k=C\mathbf{q}_k=\sum_{n=0}^r{\alpha_n},
  \end{equation}
  where $\alpha_n\in\mathbf{q}_k$ are the $r+1$ state's components at $k$ with $r$ being a preassigned arbitrary order from~(\ref{eq:fourier}), and $C$ is described in Equation~(\ref{eq:state-details}).
\end{thm}
\begin{proof}
  *\\
\end{proof}

\subsection{State estimation}
\label{sec:state-est}

As the environment uncertainty and measurement error evolve in a normal distribution, we use a Kalman filter~\cite{stengel1994optimal, simon2006optimal} for the purpose of state estimation. 

The prediction is done using
\begin{subequations}\label{eq:kalman-pred}\begin{align}
  \hat{\mathbf{q}}_{k+1}^-&=A\hat{\mathbf{q}}_{k}+B\mathbf{u}_k,\label{eq:kalman-pred1}\\
  P_{k+1}^-&=AP_kA^T+Q,\label{eq:kalman-pred2}
\end{align}\end{subequations}
where $\hat{\mathbf{q}}_k^-,\hat{\mathbf{q}}_k\in\mathbb{R}^j$ depicts the estimate of the state before and after measurement (or simply estimate), and $P_k,P_k^-\in\mathbb{R}^{j\times j}$ the error covariance matrix (i.e., the variance of the estimate). 

The estimation of the state and the update of the predicted output is done using
\begin{subequations}\label{eq:kalman-est}\begin{align}
  K_k&=(CP_{k+1}^-C^T+R)^{-1}(P_{k+1}^-C^T),\\
  \hat{\mathbf{q}}_{k+1}&=\hat{\mathbf{q}}_{k+1}^-+K_k(y_k^s+y_k^c-C\hat{\mathbf{q}}_{k+1}^-),\label{eq:kalman-est2}\\
  P_{k+1}&=(I-K_kC)P_{k+1}^-,\\
  \hat{y}_k&=C\hat{\mathbf{q}}_{k+1},\label{eq:kalman-est4}
\end{align}
\end{subequations}
where $K_k\in\mathbb{R}^j$ is the gain of the Kalman filter, and $I$ the identity matrix. $y_k^s,y_k^c$ are the instantaneous energy readings: $y_k^s\in\mathbb{R}_{\geq 0}$ the robot sensor, i.e., the energy due to the trajectory, and $y_k^c$ the energy of a given software configuration described in Equation~(\ref{eq:energy-comp}). The noise covariance matrices $Q\in\mathbb{R}^{j\times j},R\in\mathbb{R}$ indicates the uncertainty and measurement error covariance respectively, and $\hat{y}_k\in\mathbb{R}_{\geq 0}$ is the estimated energy.

Equations~(\ref{eq:kalman-pred}--\ref{eq:kalman-est}) converge to the predicted energy evolution as follows. An initial guess of the values $\hat{\mathbf{q}}_0,P_0$ is derived empirically from collected data. It is worth considering that an appropriate guess of these parameters allows the algorithm to converge to the desired energy evolution in a shorter amount of time. The tuning parameters $Q,R$ are also derived from the collected data, and may differ due to i.e., different sensors used to measure the instantaneous energy consumption, or different atmospheric conditions accounting for the process noise.

At time $k=0$, the initial estimate before measurement of the state and of the error covariance matrix is updated in Equation~(\ref{eq:kalman-pred1})~and~(\ref{eq:kalman-pred2}) respectively. The value of $\hat{\mathbf{q}}_1^-$ is then used in Equation~(\ref{eq:kalman-est2}) to estimate the current state along with the data from the sensor $y_0$ (e.g., the energy sensor of the flight controller of the fixed-wing craft), where the sensor noise covariance matrix $R$ accounts for the amount of uncertainty in the measurement. The estimated output $\hat{y}_0$ is then obtained from Equation~(\ref{eq:kalman-est4}). The algorithm is iterative. At time $k=1$ the values $\hat{\mathbf{q}}_1,P_1$ computed at previous step are used to estimate the values $\hat{\mathbf{q}}_2,P_2,$ and $y_1$.

\subsection{Optimal control action}

*

\subsection{Deployment algorithm}

*

%%%%%%%%%%%%%%%%%%%%
\section{Evaluation}
\label{sec:experimental}

*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Conclusion and Future Work}
\label{sec:conclusion}

*

\bibliographystyle{IEEEtran}
\bibliography{\jobname} 
\vspace{0.1ex}

\newpage

\end{document}
