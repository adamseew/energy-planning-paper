
%%
%% Conference Paper for ICRA'21, May 16-22, Xi'an, China
%% 
%%

\documentclass[letterpaper,10pt,conference]{ieeeconf}

\IEEEoverridecommandlockouts 

\newcommand{\stt}[1]{{\small\tt #1}} %\small\tt too small here
\newcommand{\powprof}{\stt{powprofiler}}
\newcommand{\figpath}{./figures}
\newcommand{\iu}{{i\mkern1mu}}
\let\labelindent\relax

\usepackage[inline]{enumitem}
\usepackage{booktabs}
\usepackage{flushend}
\usepackage{tikz}

%% citation packege
\usepackage{cite}

%% figures package
%\usepackage[pdftex]{graphicx}
%\graphicspath{{figures/}}
%\DeclareGraphicsExtensions{.pdf,.jpeg,.png}

%% math package
\usepackage[cmex10]{amsmath}
\usepackage{mathtools}
\usepackage{amssymb}
\usepackage{arydshln}
\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}

%% pseudocode package
%\usepackage{algorithmic}

%% packages for alignment
%\usepackage{array}
%\usepackage{mdwmath}
%\usepackage{mdwtab}
%\usepackage{eqparbox}

%% packages for subfigures (eventually)
\usepackage[tight,footnotesize]{subfigure}
%\usepackage[caption=false]{caption}
%\usepackage[font=footnotesize]{subfig}
%\usepackage[caption=false,font=footnotesize]{subfig}

%% package for urls
\usepackage{url}

\usepackage{textpos}

%% correct bad hyphenation here
\hyphenation{}

%% references (generates a bib file for bibtex)
\begin{filecontents}{\jobname.bib}
  @inproceedings{seewald2020mechanical,
    title={Mechanical and Computational Energy Estimation of a Fixed-Wing Drone}, 
    author={Seewald, Adam and Garcia de Marina, Hector and Midtiby, Henrik Skov and Schultz, Ulrik Pagh},
    booktitle={Proceedings of the 2020 Fourth IEEE International Conference on Robotic Computing (IRC)},
    pages={to appear},
    year={2020},
    organization={IEEE},
    url={https://adamseew.bitbucket.io/short/mechanical2020}
  }
  @article{seewald2019coarse,
    title={Coarse-Grained Computation-Oriented Energy Modeling for Heterogeneous Parallel Embedded Systems},
    author={Seewald, Adam and Schultz, Ulrik Pagh and Ebeid, Emad and Midtiby, Henrik Skov},
    journal={International Journal of Parallel Programming},
    pages={1--22},
    year={2019},
    publisher={Springer}
  }
  @inproceedings{seewald2019component,
    title={Component-based computation-energy modeling for embedded systems},
    author={Seewald, Adam and Schultz, Ulrik Pagh and Roeder, Julius and Rouxel, Benjamin and Grelck, Clemens},
    booktitle={Proceedings Companion of the 2019 ACM SIGPLAN International Conference on Systems, Programming, Languages, and Applications: Software for Humanity},
    pages={5--6},
    year={2019},
    organization={ACM}
  }
  @inproceedings{boroujerdian2018compute,
    title={Why Compute Matters for UAV Energy Efficiency?},
    author={Boroujerdian, Behzad and Genc, Hasan and Krishnan, Srivatsan and Faust, Aleksandra and Reddi, Vijay Janapa},
    booktitle={2nd International Symposium on Aerial Robotics},
    year={2018}
  }
  @inproceedings{hajjaj2014review,
    title={Review of research in the area of agriculture mobile robots},
    author={Hajjaj, Sami Salama Hussen and Sahari, Khairul Salleh Mohamed},
    booktitle={The 8th International Conference on Robotic, Vision, Signal Processing \& Power Applications},
    pages={107--117},
    year={2014},
    organization={Springer}
  }
  @inproceedings{qingchun2012study,
    title={Study on strawberry robotic harvesting system},
    author={Qingchun, Feng and Wengang, Zheng and Quan, Qiu and Kai, Jiang and Rui, Guo},
    booktitle={2012 IEEE International Conference on Computer Science and Automation Engineering (CSAE)},
    volume={1},
    pages={320--324},
    year={2012},
    organization={IEEE}
  }
  @article{edan2000robotic,
    title={Robotic melon harvesting},
    author={Edan, Yael and Rogozin, Dima and Flash, Tamar and Miles, Gaines E},
    journal={IEEE Transactions on Robotics and Automation},
    volume={16},
    number={6},
    pages={831--835},
    year={2000},
    publisher={IEEE}
  }
  @inproceedings{aljanobi2010setup,
    title={A setup of mobile robotic unit for fruit harvesting},
    author={Aljanobi, AA and Al-Hamed, SA and Al-Suhaibani, SA},
    booktitle={19th International Workshop on Robotics in Alpe-Adria-Danube Region (RAAD 2010)},
    pages={105--108},
    year={2010},
    organization={IEEE}
  }
  @article{de2011design,
    title={Design and control of an apple harvesting robot},
    author={De-An, Zhao and Jidong, Lv and Wei, Ji and Ying, Zhang and Yu, Chen},
    journal={Biosystems engineering},
    volume={110},
    number={2},
    pages={112--122},
    year={2011},
    publisher={Elsevier}
  }
  @article{dong2011development,
    title={Development of a row guidance system for an autonomous robot for white asparagus harvesting},
    author={Dong, Fuhong and Heinemann, Wolfgang and Kasper, Roland},
    journal={Computers and Electronics in Agriculture},
    volume={79},
    number={2},
    pages={216--225},
    year={2011},
    publisher={Elsevier}
  }
  @inproceedings{li2008analysis,
    title={Analysis of workspace and kinematics for a tomato harvesting robot},
    author={Li, Zhiguo and Liu, Jizhan and Li, Pingping and Li, Wei},
    booktitle={2008 International Conference on Intelligent Computation Technology and Automation (ICICTA)},
    volume={1},
    pages={823--827},
    year={2008},
    organization={IEEE}
  }
  @article{puri2017agriculture,
    title={Agriculture drones: A modern breakthrough in precision agriculture},
    author={Puri, Vikram and Nayyar, Anand and Raja, Linesh},
    journal={Journal of Statistics and Management Systems},
    volume={20},
    number={4},
    pages={507--518},
    year={2017},
    publisher={Taylor \& Francis}
  }
  @inproceedings{mei2005case,
    title={A case study of mobile robot's energy consumption and conservation techniques},
    author={Mei, Yongguo and Lu, Yung-Hsiang and Hu, Y Charlie and Lee, CS George},
    booktitle={ICAR'05. Proceedings., 12th International Conference on Advanced Robotics, 2005.},
    pages={492--497},
    year={2005},
    organization={IEEE}
  }
  @inproceedings{mei2004energy,
    title={Energy-efficient motion planning for mobile robots},
    author={Mei, Yongguo and Lu, Yung-Hsiang and Hu, Y Charlie and Lee, CS George},
    booktitle={IEEE International Conference on Robotics and Automation, 2004. Proceedings. ICRA'04. 2004},
    volume={5},
    pages={4344--4349},
    year={2004},
    organization={IEEE}
  }
  @article{mei2006deployment,
    title={Deployment of mobile robots with energy and timing constraints},
    author={Mei, Yongguo and Lu, Yung-Hsiang and Hu, Yu Charlie and Lee, CS George},
    journal={IEEE Transactions on robotics},
    volume={22},
    number={3},
    pages={507--522},
    year={2006},
    publisher={IEEE}
  }
  @inproceedings{uragun2011energy,
    title={Energy efficiency for unmanned aerial vehicles},
    author={Uragun, Balemir},
    booktitle={2011 10th International Conference on Machine Learning and Applications and Workshops},
    volume={2},
    pages={316--320},
    year={2011},
    organization={IEEE}
  }
  @inproceedings{kreciglowa2017energy,
    title={Energy efficiency of trajectory generation methods for stop-and-go aerial robot navigation},
    author={Kreciglowa, Nadia and Karydis, Konstantinos and Kumar, Vijay},
    booktitle={2017 International Conference on Unmanned Aircraft Systems (ICUAS)},
    pages={656--662},
    year={2017},
    organization={IEEE}
  }
  @article{kanellakis2017survey,
    title={Survey on computer vision for UAVs: Current developments and trends},
    author={Kanellakis, Christoforos and Nikolakopoulos, George},
    journal={Journal of Intelligent \& Robotic Systems},
    volume={87},
    number={1},
    pages={141--168},
    year={2017},
    publisher={Springer}
  }
  @article{sadrpour2013mission,
    title={Mission Energy Prediction for Unmanned Ground Vehicles Using Real-time Measurements and Prior Knowledge},
    author={Sadrpour, Amir and Jin, Jionghua and Ulsoy, A Galip},
    journal={Journal of Field Robotics},
    volume={30},
    number={3},
    pages={399--414},
    year={2013},
    publisher={Wiley Online Library}
  }
  @inproceedings{sadrpour2013experimental,
    title={Experimental validation of mission energy prediction model for unmanned ground vehicles},
    author={Sadrpour, Amir and Jin, Judy and Ulsoy, A Galip},
    booktitle={2013 American Control Conference},
    pages={5960--5965},
    year={2013},
    organization={IEEE}
  }
  @article{berenz2012autonomous,
    title={Autonomous battery management for mobile robots based on risk and gain assessment},
    author={Berenz, Vincent and Tanaka, Fumihide and Suzuki, Kenji},
    journal={Artificial Intelligence Review},
    volume={37},
    number={3},
    pages={217--237},
    year={2012},
    publisher={Springer}
  }
  @inproceedings{kim2005energy,
    title={Energy-saving 3-step velocity control algorithm for battery-powered wheeled mobile robots},
    author={Kim, Chong Hui and Kim, Byung Kook},
    booktitle={Proceedings of the 2005 IEEE international conference on robotics and automation},
    pages={2375--2380},
    year={2005},
    organization={IEEE}
  }
  @inproceedings{kim2008minimum,
    title={Minimum-energy translational trajectory planning for battery-powered three-wheeled omni-directional mobile robots},
    author={Kim, Hongjun and Kim, Byung-Kook},
    booktitle={2008 10th International Conference on Control, Automation, Robotics and Vision},
    pages={1730--1735},
    year={2008},
    organization={IEEE}
  }
  @article{morales2009power,
    title={Power consumption modeling of skid-steer tracked mobile robots on rigid terrain},
    author={Morales, Jesus and Martinez, Jorge L and Mandow, Anthony and Garc{\'\i}a-Cerezo, Alfonso J and Pedraza, Salvador},
    journal={IEEE Transactions on Robotics},
    volume={25},
    number={5},
    pages={1098--1108},
    year={2009},
    publisher={IEEE}
  }
  @book{wahab2015energy,
    title={Energy modeling of differential drive robots},
    author={Wahab, Mudasser and Rios-Gutierrez, Fernando and El Shahat, Adel},
    year={2015},
    publisher={IEEE}
  }
  @article{rao2003battery,
    title={Battery modeling for energy aware system design},
    author={Rao, Ravishankar and Vrudhula, Sarma and Rakhmatov, Daler},
    journal={Computer},
    volume={36},
    number={12},
    pages={77--87},
    year={2003},
    publisher={IEEE}
  }
  @inproceedings{chiasson2003estimating,
    title={Estimating the state of charge of a battery},
    author={Chiasson, John and Vairamohan, Baskar},
    booktitle={Proceedings of the 2003 American Control Conference, 2003.},
    volume={4},
    pages={2863--2868},
    year={2003},
    organization={IEEE}
  }
  @inproceedings{pang2001battery,
    title={Battery state-of-charge estimation},
    author={Pang, Shuo and Farrell, Jay and Du, Jie and Barth, Matthew},
    booktitle={Proceedings of the 2001 American control conference.(Cat. No. 01CH37148)},
    volume={2},
    pages={1644--1649},
    year={2001},
    organization={IEEE}
  }
  @article{partovibakhsh2014adaptive,
    title={An adaptive unscented Kalman filtering approach for online estimation of model parameters and state-of-charge of lithium-ion batteries for autonomous mobile robots},
    author={Partovibakhsh, Maral and Liu, Guangjun},
    journal={IEEE Transactions on Control Systems Technology},
    volume={23},
    number={1},
    pages={357--363},
    year={2014},
    publisher={IEEE}
  }
  @inproceedings{zhang2009battery,
    title={Battery state estimation using unscented kalman filter},
    author={Zhang, Fei and Liu, Guangjun and Fang, Lijin},
    booktitle={2009 IEEE International Conference on Robotics and Automation},
    pages={1863--1868},
    year={2009},
    organization={IEEE}
  }
  @inproceedings{hasan2018exogenous,
    title={Exogenous kalman filter for state-of-charge estimation in lithium-ion batteries},
    author={Hasan, Agus and Skriver, Martin and Johansen, Tor Arne},
    booktitle={2018 IEEE Conference on Control Technology and Applications (CCTA)},
    pages={1403--1408},
    year={2018},
    organization={IEEE}
  }
  @inproceedings{nardi2015introducing,
    title={Introducing SLAMBench, a performance and accuracy benchmarking methodology for SLAM},
    author={Nardi, Luigi and Bodin, Bruno and Zia, M Zeeshan and Mawer, John and Nisbet, Andy and Kelly, Paul HJ and Davison, Andrew J and Luj{\'a}n, Mikel and O'Boyle, Michael FP and Riley, Graham and others},
    booktitle={2015 IEEE International Conference on Robotics and Automation (ICRA)},
    pages={5783--5790},
    year={2015},
    organization={IEEE}
  }
  @online{px4,
    author={PX4},
    title={{PX4} open-source autopilot},
    url={https://px4.io/},
    urldate={2016-09-01}
  }
  @online{papa,
    author={Paparazzi},
    title={{UAV} open-source project},
    url={http://wiki.paparazziuav.org/},
    urldate={2016-09-01}
  }
  @online{nano,
    author={NVIDIA},
    title={{NVIDIA Jetson Nano} developer kit},
    url={https://developer.nvidia.com/embedded/jetson-nano-developer-kit},
    urldate={2020-02-02}
  }
  @online{opterra,
    author={Horizon Hobby},
    title={{Opterra} 2m Wing BNF Basic},
    url={https://www.horizonhobby.com/opterra-2m-wing-bnf-basic-p-efl11150},
    urldate={2020-02-02}
  }
  @online{meier2013mavlink,
    title={Mavlink: Micro air vehicle communication protocol},
    author={Meier, Lorenz and Camacho, J and Godbolt, B and Goppert, J and Heng, L and Lizarraga, M and others},
    url={https://mavlink.io/},
    urldate={2020-02-02}
  }
  https://mavlink.io/
  @article{ullah2018pednet,
    title={Pednet: A spatio-temporal deep convolutional neural network for pedestrian segmentation},
    author={Ullah, Mohib and Mohammed, Ahmed and Alaya Cheikh, Faouzi},
    journal={Journal of Imaging},
    volume={4},
    number={9},
    pages={107},
    year={2018},
    publisher={Multidisciplinary Digital Publishing Institute}
  }
  @inproceedings{sandler2018mobilenetv2,
    title={Mobilenetv2: Inverted residuals and linear bottlenecks},
    author={Sandler, Mark and Howard, Andrew and Zhu, Menglong and Zhmoginov, Andrey and Chen, Liang-Chieh},
    booktitle={Proceedings of the IEEE conference on computer vision and pattern recognition},
    pages={4510--4520},
    year={2018}
  }
  @inproceedings{quigley2009ros,
    title={ROS: an open-source Robot Operating System},
    author={Quigley, Morgan and Conley, Ken and Gerkey, Brian and Faust, Josh and Foote, Tully and Leibs, Jeremy and Wheeler, Rob and Ng, Andrew Y},
    booktitle={ICRA workshop on open source software},
    volume={3},
    number={3.2},
    pages={5},
    year={2009}
  }
  @book{stengel1994optimal,
    title={Optimal control and estimation},
    author={Stengel, Robert F},
    year={1994},
    publisher={Courier Corporation}
  }
  @book{simon2006optimal,
    title={Optimal state estimation: Kalman, H infinity, and nonlinear approaches},
    author={Simon, Dan},
    year={2006},
    publisher={John Wiley \& Sons}
  }
  @inproceedings{de2017guidance,
    title={Guidance algorithm for smooth trajectory tracking of a fixed wing UAV flying in wind flows},
    author={De Marina, Hector Garcia and Kapitanyuk, Yuri A and Bronz, Murat and Hattenberger, Gautier and Cao, Ming},
    booktitle={2017 IEEE international conference on robotics and automation (ICRA)},
    pages={5740--5745},
    year={2017},
    organization={IEEE}
  }
  @book{rawlings2017model,
    title={Model predictive control: theory, computation, and design},
    author={Rawlings, James Blake and Mayne, David Q and Diehl, Moritz},
    volume={2},
    year={2017},
    publisher={Nob Hill Publishing Madison, WI}
  }
\end{filecontents}

\title{\LARGE \bf
***
}

%% author names and affiliations
\author{
  Adam Seewald$^{*}$, Hector Garcia de Marina, and Ulrik Pagh Schultz
  \thanks{$^{*}$Corresponding author; email: {\tt\small ads@mmmi.sdu.dk}}
  \thanks{Adam Seewald, Ulrik Pagh Schultz are with the SDU UAS Center, M{\ae}rsk Mc-Kinney M{\o}ller Institute, University of Southern Denmark, Odense, Denmark.}
  \thanks{Hector Garcia de Marina is with the Faculty of Physics, Department of Computer Architecture and Automatic Control, Universidad Computense de Madrid, Spain.}
}

\begin{document}

%% make the title area
\maketitle

\thispagestyle{empty}
\pagestyle{empty}

\begin{abstract}

  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract
\end{abstract}

% For peer review papers, you can put extra information on the cover
% page as needed:
% \ifCLASSOPTIONpeerreview
% \begin{center} \bfseries EDICS Category: 3-BBND \end{center}
% \fi
%
% For peerreview papers, this IEEEtran command inserts a page break and
% creates the second title. It will be ignored for other modes.
\IEEEpeerreviewmaketitle

%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}

% what I want to do with words.
% diggested version of the technical details
% strory goes to the introduction
% depends
% big picture in the introduction to agree what specifically I am trying to do right now
*

%%%%%%%%%%%%%%%%%%%%%%
\section{State of the Art}
\label{sec:related}

*
% equation number just just for illustrate the reader just to introduce and support - this is an offline method
% but we need it in real time while we are flying
% we write number one as number 4
% one of the things is to figure out what are the states
% t

%%%%%%%%%%%%%%%%%%%%%%%%%%%
% once the introduction 
\section{Model}
\label{sec:estimation}

The model presented in this section deals with the motion and the energy using two different systems, subject to the same process noise $w$ (i.e., the atmospheric interference such as wind). 

The motion defines a trajectory and a position $\mathbf{p}$; the trajectory is expressed through explicit trajectory equation $\varphi$, while the position determines a vehicle frame $\mathcal{O}_V$ in the 2D Euler space relative to an inertial frame $\mathcal{O}_W$. For the sake of simplicity, it is assumed that the $z$-axis is constrained to a specific altitude $h$, with the system being free to evolve in the $x,y$-axes (i.e., the drone is flying, performing a mission, at a given height). A motion guidance action is derived using vector field design, enabling the convergence to the desired trajectory anywhere in $\mathcal{O}_W$. 

The energy $\mathbf{q}$ spent to perform such guidance action is later derived using Fourier analysis in its state-space representation. This component is decomposed in the energy needed for the actuation (i.e., the mechanical energy), and the computations (i.e., the computational energy), an approach that has been extensively reviewed in our previous work~\cite{seewald2019coarse, seewald2019component, seewald2020mechanical}. A control action, which varies quality of service (QoS) levels of the software being executed, is derived for this purpose. The main goal is to tune the explicit energy equation allowing to maximize the computational and mechanical outcome of the mission while trying to minimize the eventuality of battery discharge.

\subsection{Motion and Guidance Model}
The position $\mathbf{p}$, derived from~\cite{de2017guidance}, is described using the following non-holonomic model
\begin{equation}\label{eqq:1}\begin{cases}
  \dot{\mathbf{p}}(t)&=s\Psi(\psi(t))+w(t)\\
  \dot{\psi}(t)&=u(t)
\end{cases},
\end{equation}
where $\mathbf{p}(t)\in\mathbb{R}^2$ is a point in $\mathcal{O}_W$, $s\in\mathbb{R}$ describes the airspeed assumed constant, $\psi(t)\in(-\pi,\pi]$ the attitude yaw angle and $\Psi(\psi(t))=\begin{bmatrix}\cos{\psi(t)} & \sin{\psi(t)}\end{bmatrix}^T$, and $u\in\mathbb{R}$ the guidance action which denotes the angular velocity $\dot{\psi}$ of $\mathcal{O}_V$.

Let us define a generic continuously differentiable function $\varphi:\mathbb{R}^2\rightarrow\mathbb{R}$. The desired trajectory $\mathcal{P}$ can be defined
\begin{equation}\label{eqq:2}
  \mathcal{P}:=\{\mathbf{p}:\|\varphi(\mathbf{p})\|<c+\varepsilon\},
\end{equation}
as the set of points that follows an explicit trajectory equation $\varphi(\mathbf{p})=c$ within a given $\varepsilon\in\mathbb{R}_{\geq 0}$. 

Given a set of discrete values $c$, $\mathcal{O}_W$ can be covered by all the trajectories $\mathcal{P}$ within specific boundaries $\underline{c}\leq c\leq \overline{c}$, where $\underline{a},\overline{a}$ returns the upper bound and lower bound limit of $a$ from the mission specification, which is a lookup table.

The concept of a trajectory is used later to design a controller that selects $c$ with the highest energy value under the energy budget constraints. Here we design a guidance action $u$ that allows following such trajectory. The guidance is derived using the vector field approach also presented in~\cite{de2017guidance}. The algorithm heads to $\mathcal{P}$ by the means of minimizing the norm in Equation~(\ref{eqq:2}).

Let us define $\varPhi:=\varphi(\mathbf{p})$. The vector field is defined as the desired velocity vector
\begin{equation}\label{eqq:3}
  \dot{\mathbf{p}}_d(\mathbf{p}):=E\nabla\varPhi-k_e\varPhi\nabla\varPhi,\,\,\,E=\begin{bmatrix}
    0&1\\-1&0
  \end{bmatrix},
\end{equation}
where $\nabla\varPhi\in\mathbb{R}^2$ is defined as the gradient of $\varphi$ at the point $\mathbf{p}$ (i.e., its vector field), $E$ specifies the tracking direction, and $k_e\in\mathbb{R}_{\geq 0}$ the gain which adjusts the speed of convergence of the vector field to the desired trajectory.

The direction the velocity vector $\dot{\mathbf{p}}$ is pointing at is generally different from the course heading $\chi\in(-\pi,\pi]$ due to the atmospheric interference.

Let us further define $\hat{\mathbf{p}}:=\mathbf{p}/\|\mathbf{p}\|$, the desired course heading rate $\dot{\chi_d}$ is computed by sensing the position $\mathbf{p}$, the ground velocity $\dot{\mathbf{p}}$, and is expressed
\begin{equation}\label{eqq:4}\begin{split}
  &\dot{\chi}(\dot{\mathbf{p}},\mathbf{p})=-E\frac{\dot{\mathbf{p}}_d}{\|\dot{\mathbf{p}}_d\|^2}\cdot\\
  &\hspace{2ex}\left( E\hat{\dot{\mathbf{p}}}_d\hat{\dot{\mathbf{p}}}_d^T\left( (E-k_e\varPhi)H(\varPhi)\dot{\mathbf{p}}-k_e\nabla\varPhi^T\dot{\mathbf{p}}\nabla\varPhi \right) \right)^T,
\end{split}
\end{equation} 
where $H(\cdot)$ is defined as the Hessian operator; the physical meaning is that the curvature of the desired trajectory has to be known in order to be tracked.

Under the assumption of the airspeed $s>\|w(t)\|$ for $t>0$ (i.e., the constant airspeed is greater than the norm of the wind), the guidance action can be expressed
\begin{equation}\label{eqq:5}
  u(\dot{\mathbf{p}},\mathbf{p},\psi)=\frac{\|\mathbf{p}\|}{s\cos{\beta}}\left( \dot{\mathbf{\chi}}_d(\dot{\mathbf{p}},\mathbf{p})+k_d\hat{\dot{\mathbf{p}}}^TE\hat{\dot{\mathbf{p}}}_d \right),
\end{equation} 
where $k_d\in\mathbb{R}_{\geq 0}$ is the gain which adjusts the speed of the convergence of $\dot{\mathbf{p}}_d$, $\beta=\cos^{-1}{\left( \hat{\dot{\mathbf{p}}}^T\Psi(\psi) \right)}$ is the sideslip angle, and $\dot{\chi}_d$ is given in Equation~(\ref{eqq:4}).

\subsection{Energy Model}

To evaluate the energy spent performing given actuation and computations we consider a Fourier series $f:\mathbb{R}_{\geq 0}\rightarrow\mathbb{R}_{\geq 0}$ of an arbitrary order $r$
\begin{equation}\label{eqq:6}
  f(t)=\sum_{n=0}^{r}{a_n\cos{\frac{nt}{\xi}}+b_n\sin{\frac{nt}{\xi}}},
\end{equation}
where $\xi\in\mathbb{R}$ is the characteristic time, and $a_n, b_n\in\mathbb{R}$ for $n\in\{0,\dotsc,r\}$ the Fourier series coefficients. The Fourier analysis allows accounting for the periodicity of the mission, with a trajectory $\mathcal{P}$ being reiterated over time. 

The non-linear model in Equation~(\ref{eqq:6}) can be expressed using an equivalent time-varying state-space model in the following form
\begin{equation}\label{eqq:7}\begin{cases}
  \dot{\mathbf{q}}(t)&=A\mathbf{q}(t)+B\mathbf{u}(t)+w(t)\\
  y(t)&=C\mathbf{q}(t)+v(t)
\end{cases},\end{equation}
where $y(t)\in\mathbb{R}_{\geq 0}$ is the energy evolution of the system being controlled, $w(t)$ the same process noise of the system in Equation~(\ref{eqq:1}), and $v(t)\in\mathbb{R}_{\geq 0}$ the measurement noise. The control $\mathbf{u}$ along with the input matrix $B$ are defined subsequently. The state $\mathbf{q}$ represents the evolution of the Fourier series coefficients in time, which can be expressed along with the state transition matrix, and the output matrix
\begin{equation}\begin{split}
  \mathbf{q}(t)&=\left[\begin{array}{ccccccc}
    a_0 & \vline & a_1 & b_1 & \cdots & a_r & b_r
  \end{array}\right]^T,\\
  A&=\left[\begin{array}{ccccc}
    1          & \vline & \mathbf{0} & \cdots & \mathbf{0} \\\hline
    \mathbf{0} & \vline & A_1        & \cdots & \mathbf{0} \\
    \vdots     & \vline & \vdots     & \ddots & \vdots     \\
    \mathbf{0} & \vline & \mathbf{0} & \cdots & A_r 
  \end{array}\right],\,A_n=\begin{bmatrix}0 & \frac{n}{\xi} \\ -\frac{n^2}{\xi^2} & 0\end{bmatrix},\\
  C&=\left[\begin{array}{ccccccc}
    1 & \vline & 1 & 0 & \cdots & 1 & 0
  \end{array}\right],
\end{split}\end{equation}
where $\mathbf{q}(t)\in\mathbb{R}^j$ given $j:=2r+1$, $A\in\mathbb{R}^{j\times j}$ is the state transmission matrix, and $C\in\mathbb{R}^j$ is the output matrix. Furthermore, the first row and column of the matrix $A$ contain zeros row vectors and column vectors respectively.

Motivated by the fact that the system of interest is sampled discrete-time, and for the sake of simplicity, we consider the discretized version of Equation~(\ref{eqq:1})~and~(\ref{eqq:7})
\begin{subequations}\label{eqq:9}\begin{align}
  &\begin{cases}\label{eqq:9a}
  \mathbf{p}_{k+1}&=s\Psi(\psi_k)+w_k\\
  \psi_{k+1}&=u_k
  \end{cases},\\
  &\begin{cases}\label{eqq:9b}
  \mathbf{q}_{k+1}&=A\mathbf{q}_{k}+B\mathbf{u}_{k}+w_k\\
  y_k&=C\mathbf{q}_k+v_k
  \end{cases}.
\end{align}\end{subequations}

As the system was observed to behave stochastically, with the process and measurement noise evolving in a normal distribution, a Kalman filter~\cite{stengel1994optimal, simon2006optimal} is employed to predict the state $\hat{\mathbf{q}}$. Such a state, along with the predicted output $\hat{y}$, differs from the model state $\mathbf{q}$ and measured output $y$ in Equation~(\ref{eqq:9b}) due to the presence of uncertainty.

The prediction is done using
\begin{subequations}\label{eqq:10}\begin{align}
  \hat{\mathbf{q}}_{k+1}^-&=A\hat{\mathbf{q}}_{k}+B\mathbf{u}_k,\label{eqq:10a}\\
  P_{k+1}^-&=AP_kA^T+Q,\label{eqq:10b}
\end{align}\end{subequations}
where $\hat{\mathbf{q}}_k^-,\hat{\mathbf{q}}_k\in\mathbb{R}^j$ depicts the estimate of the state before and after measurement (or simply estimate), and $P_k,P_k^-\in\mathbb{R}^{j\times j}$ the error covariance matrix (i.e., the variance of the estimate). 

The estimation of the state and the update of the predicted output is done using
\begin{subequations}\label{eqq:11}\begin{align}
  K_k&=(CP_{k+1}^-C^T+R)^{-1}(P_{k+1}^-C^T),\\
  \hat{\mathbf{q}}_{k+1}&=\hat{\mathbf{q}}_{k+1}^-+K_k(y_k^s+y_k^c-C\hat{\mathbf{q}}_{k+1}^-),\label{eqq:11b}\\
  P_{k+1}&=(I-K_kC)P_{k+1}^-,\\
  \hat{y}_k&=C\hat{\mathbf{q}}_{k+1},\label{eqq:11d}
\end{align}
\end{subequations}
where $K_k\in\mathbb{R}^j$ is the gain of the Kalman filter, and $I$ the identity matrix. $y_k^s,y_k^c$ are the energy readings: $y_k^s$ the flight controller sensor, i.e., the energy needed for the actuation, and $y_k^c$ the energy of a given software configuration described in Equation~(\ref{eqq:13}) later in this section. The noise covariance matrices $Q\in\mathbb{R}^{j\times j},R\in\mathbb{R}$ indicates the process noise and sensor noise covariance respectively, and $\hat{y}_k\in\mathbb{R}_{\geq 0}$ is the estimated energy.

Equations~(\ref{eqq:10}--\ref{eqq:11}) converge to the predicted energy evolution as follows. An initial guess of the values $\hat{\mathbf{q}}_0,P_0$ is derived empirically from collected data. It is worth considering that an appropriate guess of these parameters allows the system to converge to the desired energy evolution in a shorter amount of time. The tuning parameters $Q,R$ are also derived from the collected data, and may differ due to i.e., different sensors used to measure the instantaneous energy consumption, or different atmospheric conditions accounting for the process noise.

At time $k=0$, the initial estimate before measurement of the state and of the error covariance matrix is updated in Equation~(\ref{eqq:10a})~and~(\ref{eqq:10b}) respectively. The value of $\hat{\mathbf{q}}_1^-$ is then used in Equation~(\ref{eqq:11b}) to estimate the current state along with the data from the sensor $y_0$ (we use the energy sensor of the flight controller), where the sensor noise covariance matrix $R$ accounts for the amount of uncertainty in the measurement. The estimated output $\hat{y}_0$ is then obtained from Equation~(\ref{eqq:11d}). The algorithm is iterative. At time $k=1$ the values $\hat{\mathbf{q}}_1,P_1$ computed at previous step are used to estimate the values $\hat{\mathbf{q}}_2,P_2,$ and $y_1$.

In the light of Equations~(\ref{eqq:9}--\ref{eqq:11}), the main goal stated earlier in this section can be updated. We aim to find an optimal control action $\mathbf{u}^0$ for the current state $\hat{\mathbf{q}}$ from the optimal control law $\mathbf{u}^0=:\kappa(\hat{\mathbf{q}})$~\cite{rawlings2017model}. This is achieved by solving online a finite horizon optimal control problem by the hand of a model predictive control (MPC) algorithm derived in the next section. Before, we need to define a generic control action $\mathbf{u}$.

\subsection{Computational Model}

A computational energy model is built using \powprof{}\footnote{\label{cross-ref:powprof-link}\url{https://bitbucket.org/adamseew/powprofiler}}, an open-source modeling tool that measures empirically software configurations and builds an energy model accordingly~\cite{seewald2019coarse}. Specifically, the tool builds a multivariate linear interpolation which is accessed online at the hand of a lookup table in the optimal control algorithm. The system is modeled as follows. An existing ROS system composes several computationally expensive ROS nodes, allowing to vary the number of computations changing some node-specific quality of service (QoS) values via ROS parameters. The tool builds the energy model using mission specification which, besides other mission parameters, specifies per each ROS node a QoS range.

Suppose the system is composed of $\sigma$ computationally expensive ROS nodes. Let us define the computational control action
\begin{equation}\label{eqq:12}
  \mathcal{C}_k:=\left\{u:u\in\text{QoS}_n(k)\,\forall\,n\in\{0,\dots,\sigma\}\right\},
\end{equation}
where $\text{QoS}_n(t):\mathbb{Z}_{\geq 0}\rightarrow\mathbb{Z}_{\geq 0}$ returns the $n$-th QoS value at time $t$, and $\mathcal{C}_k\in\mathbb{Z}_{\geq 0}^\sigma$ the set of $\sigma$ QoS values the system is composed of at time $k$. Let us further define $g:\mathbb{Z}_{\geq 0}\times\mathbb{Z}_{\geq 0}\rightarrow\mathbb{R}_{\geq 0}$ as the instantaneous energy value obtained interrogating \powprof{}. The computational energy component can be defined
\begin{equation}\label{eqq:13}\begin{split}
  y_k^c:&=g\left(\text{QoS}_0\left(k\right),\dots,\text{QoS}_\sigma\left(k\right)\right)=g\left(\mathcal{C}_{k}\right).\\
\end{split}\end{equation}

The QoS parameters $\mathcal{C}_k$ can be subject to different constraints at different states. Physically, this means that the drone can perform the ROS nodes within different QoS ranges while flying different phases of a mission
\begin{equation}\label{eqq:14}
  \underline{\text{QoS}}_n(k)\leq \text{QoS}_n(k)\leq \overline{\text{QoS}}_n(k),\,\forall n\in\{0,\cdots,\sigma\},
\end{equation}
where the values $\underline{\text{QoS}}_n(k),\overline{\text{QoS}}_n(k)$ are retrieved from the mission specification.

The control action is constructed in two steps. Equation~(\ref{eqq:12}) defines the control due to the computations. The control due to the actuation, which describes the energy of the mechanical elements of the drone $\mathcal{M}$, is derived in the following subsection.

\subsection{Control Action}

Given a generic trajectory equation $\varphi$, the trajectory can be modeled by $\rho$ parameters $\mathcal{M}\in\mathbb{R}^\rho$, e.g., the constants of a linear function, the radius of a circle, and semi-major and minor axis of an ellipse. The set of these parameters can be expressed
\begin{equation}\label{eqq:14}
  \mathcal{M}_k:=\{\mathbf{u}_k : \varphi_k(\mathbf{p}_k^0,\mathbf{u}_k)=c_k\},
\end{equation}
where $c$ is defined in Equation~(\ref{eqq:2}), and $\mathbf{p}^0$ is any optimal point which let the trajectory explicit function $\varphi_k$ converge to the value $c$ (i.e., points over the trajectory). 

The explicit trajectory equation $\varphi_k$ can be different at different states $k$, meaning the vector field and guidance action, from Equation~(\ref{eqq:3})~and~(\ref{eqq:5}) respectively, will account for the sudden change of trajectory during the mission. Alike Equation~(\ref{eqq:14}), the parameters $\mathbf{u}_k=\{u_{k,1},\dots,u_{k,\rho_k}\}$ at time $k$ are constrained
\begin{equation}
  \underline{u}_{k,n}\leq u_{k,n}\leq \overline{u}_{k,n}\,\forall n\in\{0,\cdots,\rho_k\},
\end{equation}
where the values $\underline{u}_{k,n},\overline{u}_{k,n}$ are also retrieved from the mission specification.

It is worth considering that the number of parameters at state $k$ is a parameter of the state. This is for the sake of generality, as the mission specification might contain different explicit equations for different states. For instance, the drone might follow an ellipse function throughout the mission and heading a linear function while landing. 

The mechanical and computational control actions, $\mathcal{C}$ and $\mathcal{M}$ defined in Equation~(\ref{eqq:12})~and~(\ref{eqq:14}), are incorporated in the system in Equation~(\ref{eqq:9b}) using the input matrix
\begin{equation}\begin{split}
  \mathbf{u}_k&=\left[\begin{array}{cc}
    g\left(\mathcal{C}_k\right) & \mathcal{M}_k
  \end{array}\right]^T,\\
  B&=\left[\begin{array}{ccccccc}
    1 & \vline & 0 & \cdots & 0\\\hline
    0 & \vline & 0 & \cdots & 0\\
    \vdots & \vline & \vdots & \ddots & \vdots\\
    0 & \vline & 0 & \cdots & 0
  \end{array}\right],
\end{split}
\end{equation}
where $\mathbf{u}_k\in\mathbb{R}^l$ is the control given $l:=1+\rho$, and $B\in\mathbb{R}^{j\times l}$ is the input matrix from Equation~(\ref{eqq:7})~and~(\ref{eqq:9b}). Moreover, the first column in the first row of the input matrix is $1$, while all the other items are $0$. This adds the computational model component to the energy evolution in the system in Equation~(\ref{eqq:9b}). The energy due to the change of explicit trajectory equation parameters is not directly added to the system, which however will update the reading from the sensors in Equation~(\ref{eqq:11b}) and thus adjust the energy evolution accordingly.

%%%%%%%%%%%%%%%%%%%%
\section{Evaluation}
\label{sec:experimental}

*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Conclusion and Future Work}
\label{sec:conclusion}

*

%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Acknowledgment}

This work is supported and partly funded by the European Union's Horizon2020 research and innovation program under grant agreement No. 779882 (TeamPlay).

\bibliographystyle{IEEEtran}
\bibliography{\jobname} 
\vspace{0.1ex}

\end{document}
