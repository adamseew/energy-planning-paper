
%%
%% Conference Paper for ICRA'21, May 16-22, Xi'an, China
%% 
%%

\documentclass[letterpaper,10pt,conference]{ieeeconf}

\IEEEoverridecommandlockouts 

\newcommand{\stt}[1]{{\small\tt #1}} %\small\tt too small here
\newcommand{\powprof}{\stt{powprofiler}}
\newcommand{\figpath}{./figures}
\newcommand{\iu}{{i\mkern1mu}}
\let\labelindent\relax

\usepackage[inline]{enumitem}
\usepackage{booktabs}
\usepackage{flushend}
\usepackage{tikz}

%% citation packege
\usepackage{cite}

%% figures package
%\usepackage[pdftex]{graphicx}
%\graphicspath{{figures/}}
%\DeclareGraphicsExtensions{.pdf,.jpeg,.png}

%% math package
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{amssymb}
\usepackage{arydshln}
\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}

\let\proof\relax
\let\endproof\relax
\usepackage{amsthm}

%% pseudocode package
%\usepackage{algorithmic}

%% packages for alignment
%\usepackage{array}
%\usepackage{mdwmath}
%\usepackage{mdwtab}
%\usepackage{eqparbox}

%% packages for subfigures (eventually)
\usepackage[tight,footnotesize]{subfigure}
%\usepackage[caption=false]{caption}
%\usepackage[font=footnotesize]{subfig}
%\usepackage[caption=false,font=footnotesize]{subfig}

%% package for urls
\usepackage{url}

%% hyperref
% and an override to make hyperref work with ieeeconf.cls
\makeatletter
\let\NAT@parse\undefined
\makeatother
\usepackage{hyperref}

\usepackage{textpos}

\DeclarePairedDelimiter\abs{\lvert}{\rvert}%
\DeclarePairedDelimiter\norm{\lVert}{\rVert}%

%% correct bad hyphenation here
\hyphenation{}

\renewcommand{\qedsymbol}{$\blacksquare$}

\theoremstyle{definition}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}[thm]{Lemma}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{assm}[thm]{Assumption}
\newtheorem{cor}{Corollary}
\newtheorem{conj}{Conjecture}[section]
\newtheorem{defn}{Definition}[section]
\newtheorem{exmp}{Example}[section]
\newtheorem{rem}{Remark}

%% references (generates a bib file for bibtex)
\begin{filecontents}{\jobname.bib}
  @inproceedings{seewald2020mechanical,
    title={Mechanical and Computational Energy Estimation of a Fixed-Wing Drone}, 
    author={Seewald, Adam and Garcia de Marina, Hector and Midtiby, Henrik Skov and Schultz, Ulrik Pagh},
    booktitle={2020 4th IEEE International Conference on Robotic Computing (IRC)},
    pages={to appear},
    year={2020},
    organization={IEEE},
    url={https://adamseew.bitbucket.io/short/mechanical2020}
  }
  @article{seewald2019coarse,
    title={Coarse-Grained Computation-Oriented Energy Modeling for Heterogeneous Parallel Embedded Systems},
    author={Seewald, Adam and Schultz, Ulrik Pagh and Ebeid, Emad and Midtiby, Henrik Skov},
    journal={International Journal of Parallel Programming},
    pages={1--22},
    year={2019},
    publisher={Springer}
  }
  @inproceedings{seewald2019component,
    title={Component-based computation-energy modeling for embedded systems},
    author={Seewald, Adam and Schultz, Ulrik Pagh and Roeder, Julius and Rouxel, Benjamin and Grelck, Clemens},
    booktitle={Proceedings Companion of the 2019 ACM SIGPLAN International Conference on Systems, Programming, Languages, and Applications: Software for Humanity},
    pages={5--6},
    year={2019},
    organization={ACM}
  }
  @inproceedings{hajjaj2014review,
    title={Review of research in the area of agriculture mobile robots},
    author={Hajjaj, Sami Salama Hussen and Sahari, Khairul Salleh Mohamed},
    booktitle={The 8th International Conference on Robotic, Vision, Signal Processing \& Power Applications},
    pages={107--117},
    year={2014},
    organization={Springer}
  }
  @inproceedings{qingchun2012study,
    title={Study on strawberry robotic harvesting system},
    author={Qingchun, Feng and Wengang, Zheng and Quan, Qiu and Kai, Jiang and Rui, Guo},
    booktitle={2012 IEEE International Conference on Computer Science and Automation Engineering (CSAE)},
    volume={1},
    pages={320--324},
    year={2012},
    organization={IEEE}
  }
  @article{edan2000robotic,
    title={Robotic melon harvesting},
    author={Edan, Yael and Rogozin, Dima and Flash, Tamar and Miles, Gaines E},
    journal={IEEE Transactions on Robotics and Automation},
    volume={16},
    number={6},
    pages={831--835},
    year={2000},
    publisher={IEEE}
  }
  @inproceedings{aljanobi2010setup,
    title={A setup of mobile robotic unit for fruit harvesting},
    author={Aljanobi, AA and Al-Hamed, SA and Al-Suhaibani, SA},
    booktitle={19th International Workshop on Robotics in Alpe-Adria-Danube Region (RAAD 2010)},
    pages={105--108},
    year={2010},
    organization={IEEE}
  }
  @article{de2011design,
    title={Design and control of an apple harvesting robot},
    author={De-An, Zhao and Jidong, Lv and Wei, Ji and Ying, Zhang and Yu, Chen},
    journal={Biosystems engineering},
    volume={110},
    number={2},
    pages={112--122},
    year={2011},
    publisher={Elsevier}
  }
  @article{dong2011development,
    title={Development of a row guidance system for an autonomous robot for white asparagus harvesting},
    author={Dong, Fuhong and Heinemann, Wolfgang and Kasper, Roland},
    journal={Computers and Electronics in Agriculture},
    volume={79},
    number={2},
    pages={216--225},
    year={2011},
    publisher={Elsevier}
  }
  @inproceedings{li2008analysis,
    title={Analysis of workspace and kinematics for a tomato harvesting robot},
    author={Li, Zhiguo and Liu, Jizhan and Li, Pingping and Li, Wei},
    booktitle={2008 International Conference on Intelligent Computation Technology and Automation (ICICTA)},
    volume={1},
    pages={823--827},
    year={2008},
    organization={IEEE}
  }
  @article{puri2017agriculture,
    title={Agriculture drones: A modern breakthrough in precision agriculture},
    author={Puri, Vikram and Nayyar, Anand and Raja, Linesh},
    journal={Journal of Statistics and Management Systems},
    volume={20},
    number={4},
    pages={507--518},
    year={2017},
    publisher={Taylor \& Francis}
  }
  @inproceedings{mei2005case,
    title={A case study of mobile robot's energy consumption and conservation techniques},
    author={Mei, Yongguo and Lu, Yung-Hsiang and Hu, Y Charlie and Lee, CS George},
    booktitle={ICAR'05. Proceedings., 12th International Conference on Advanced Robotics, 2005.},
    pages={492--497},
    year={2005},
    organization={IEEE}
  }
  @inproceedings{mei2004energy,
    title={Energy-efficient motion planning for mobile robots},
    author={Mei, Yongguo and Lu, Yung-Hsiang and Hu, Y Charlie and Lee, CS George},
    booktitle={IEEE International Conference on Robotics and Automation, 2004. Proceedings. ICRA'04. 2004},
    volume={5},
    pages={4344--4349},
    year={2004},
    organization={IEEE}
  }
  @article{mei2006deployment,
    title={Deployment of mobile robots with energy and timing constraints},
    author={Mei, Yongguo and Lu, Yung-Hsiang and Hu, Yu Charlie and Lee, CS George},
    journal={IEEE Transactions on robotics},
    volume={22},
    number={3},
    pages={507--522},
    year={2006},
    publisher={IEEE}
  }
  @inproceedings{kreciglowa2017energy,
    title={Energy efficiency of trajectory generation methods for stop-and-go aerial robot navigation},
    author={Kreciglowa, Nadia and Karydis, Konstantinos and Kumar, Vijay},
    booktitle={2017 International Conference on Unmanned Aircraft Systems (ICUAS)},
    pages={656--662},
    year={2017},
    organization={IEEE}
  }
  @article{sadrpour2013mission,
    title={Mission Energy Prediction for Unmanned Ground Vehicles Using Real-time Measurements and Prior Knowledge},
    author={Sadrpour, Amir and Jin, Jionghua and Ulsoy, A Galip},
    journal={Journal of Field Robotics},
    volume={30},
    number={3},
    pages={399--414},
    year={2013},
    publisher={Wiley Online Library}
  }
  @inproceedings{sadrpour2013experimental,
    title={Experimental validation of mission energy prediction model for unmanned ground vehicles},
    author={Sadrpour, Amir and Jin, Judy and Ulsoy, A Galip},
    booktitle={2013 American Control Conference},
    pages={5960--5965},
    year={2013},
    organization={IEEE}
  }
  @inproceedings{kim2005energy,
    title={Energy-saving 3-step velocity control algorithm for battery-powered wheeled mobile robots},
    author={Kim, Chong Hui and Kim, Byung Kook},
    booktitle={Proceedings of the 2005 IEEE international conference on robotics and automation},
    pages={2375--2380},
    year={2005},
    organization={IEEE}
  }
  @inproceedings{kim2008minimum,
    title={Minimum-energy translational trajectory planning for battery-powered three-wheeled omni-directional mobile robots},
    author={Kim, Hongjun and Kim, Byung-Kook},
    booktitle={2008 10th International Conference on Control, Automation, Robotics and Vision},
    pages={1730--1735},
    year={2008},
    organization={IEEE}
  }
  @book{wahab2015energy,
    title={Energy modeling of differential drive robots},
    author={Wahab, Mudasser and Rios-Gutierrez, Fernando and El Shahat, Adel},
    year={2015},
    publisher={IEEE}
  }
  @online{px4,
    author={PX4},
    title={{PX4} open-source autopilot},
    url={https://px4.io/},
    urldate={2016-09-01}
  }
  @online{papa,
    author={Paparazzi},
    title={{UAV} open-source project},
    url={http://wiki.paparazziuav.org/},
    urldate={2016-09-01}
  }
  @online{nano,
    author={NVIDIA},
    title={{NVIDIA Jetson Nano} developer kit},
    url={https://developer.nvidia.com/embedded/jetson-nano-developer-kit},
    urldate={2020-02-02}
  }
  @online{opterra,
    author={Horizon Hobby},
    title={{Opterra} 2m Wing BNF Basic},
    url={https://www.horizonhobby.com/opterra-2m-wing-bnf-basic-p-efl11150},
    urldate={2020-02-02}
  }
  @online{meier2013mavlink,
    title={Mavlink: Micro air vehicle communication protocol},
    author={Meier, Lorenz and Camacho, J and Godbolt, B and Goppert, J and Heng, L and Lizarraga, M and others},
    url={https://mavlink.io/},
    urldate={2020-02-02}
  }
  @article{ullah2018pednet,
    title={Pednet: A spatio-temporal deep convolutional neural network for pedestrian segmentation},
    author={Ullah, Mohib and Mohammed, Ahmed and Alaya Cheikh, Faouzi},
    journal={Journal of Imaging},
    volume={4},
    number={9},
    pages={107},
    year={2018},
    publisher={Multidisciplinary Digital Publishing Institute}
  }
  @inproceedings{sandler2018mobilenetv2,
    title={Mobilenetv2: Inverted residuals and linear bottlenecks},
    author={Sandler, Mark and Howard, Andrew and Zhu, Menglong and Zhmoginov, Andrey and Chen, Liang-Chieh},
    booktitle={Proceedings of the IEEE conference on computer vision and pattern recognition},
    pages={4510--4520},
    year={2018}
  }
  @inproceedings{quigley2009ros,
    title={ROS: an open-source Robot Operating System},
    author={Quigley, Morgan and Conley, Ken and Gerkey, Brian and Faust, Josh and Foote, Tully and Leibs, Jeremy and Wheeler, Rob and Ng, Andrew Y},
    booktitle={ICRA workshop on open source software},
    volume={3},
    number={3.2},
    pages={5},
    year={2009}
  }
  @book{stengel1994optimal,
    title={Optimal control and estimation},
    author={Stengel, Robert F},
    year={1994},
    publisher={Courier Corporation}
  }
  @book{simon2006optimal,
    title={Optimal state estimation: Kalman, H infinity, and nonlinear approaches},
    author={Simon, Dan},
    year={2006},
    publisher={John Wiley \& Sons}
  }
  @inproceedings{de2017guidance,
    title={Guidance algorithm for smooth trajectory tracking of a fixed wing UAV flying in wind flows},
    author={De Marina, Hector Garcia and Kapitanyuk, Yuri A and Bronz, Murat and Hattenberger, Gautier and Cao, Ming},
    booktitle={2017 IEEE international conference on robotics and automation (ICRA)},
    pages={5740--5745},
    year={2017},
    organization={IEEE}
  }
  @book{rawlings2017model,
    title={Model predictive control: theory, computation, and design},
    author={Rawlings, James Blake and Mayne, David Q and Diehl, Moritz},
    volume={2},
    year={2017},
    publisher={Nob Hill Publishing Madison, WI}
  }
  @inproceedings{morbidi2016minimum,
    title={Minimum-energy path generation for a quadrotor UAV},
    author={Morbidi, Fabio and Cano, Roel and Lara, David},
    booktitle={2016 IEEE International Conference on Robotics and Automation (ICRA)},
    pages={1492--1498},
    year={2016},
    organization={IEEE}
  }
  @inproceedings{daponte2019review,
    title={A review on the use of drones for precision agriculture},
    author={Daponte, Pasquale and De Vito, Luca and Glielmo, Luigi and Iannelli, Luigi and Liuzza, Davide and Picariello, Francesco and Silano, Giuseppe},
    booktitle={IOP Conference Series: Earth and Environmental Science},
    volume={275},
    number={1},
    pages={012022},
    year={2019},
    organization={IOP Publishing}
  }

\end{filecontents}

\title{\LARGE \bf
Energy-Aware Dynamic Mission Planning Algorithm for UAVs
}

%% author names and affiliations
\author{
  Adam Seewald$^{1}$, Hector Garcia de Marina$^{2}$, and Ulrik Pagh Schultz$^{1}$
  \thanks{This work is supported and partly funded by the European Union's Horizon2020 research and innovation program under grant agreement No. 779882 (TeamPlay).
  }
  \thanks{$^{1}$Adam Seewald, Ulrik Pagh Schultz are with the SDU UAS Center, M{\ae}rsk Mc-Kinney M{\o}ller Institute, University of Southern Denmark, Odense, Denmark. Email: {\tt\small ads@mmmi.sdu.dk}.}
  \thanks{$^{2}$Hector Garcia de Marina is with the Faculty of Physics, Department of Computer Architecture and Automatic Control, Universidad Computense de Madrid, Spain.}
}

\begin{document}

%% make the title area
\maketitle

\thispagestyle{empty}
\pagestyle{empty}

\begin{abstract}

  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract\\
  abstract
\end{abstract}

% For peer review papers, you can put extra information on the cover
% page as needed:
% \ifCLASSOPTIONpeerreview
% \begin{center} \bfseries EDICS Category: 3-BBND \end{center}
% \fi
%
% For peerreview papers, this IEEEtran command inserts a page break and
% creates the second title. It will be ignored for other modes.
\IEEEpeerreviewmaketitle


%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
\label{sec:intro}

Planning a mission for unmanned aerial vehicles (UAVs) operating outdoors is a challenging task. Scenarios such as precision agriculture, search and rescue, and surveillance require advanced levels of autonomy along with strictly limited energy budgets--with the typical instance being a UAV used to inform its grounded counterparts of patterns detected while flying. Currently, UAVs flying outdoors are often semi-autonomous, in the sense that the mission is static and usually defined using a mission planning software~\cite{daponte2019review}. Such a state of practice has prompted us to propose an \emph{energy-aware dynamic mission planning algorithm} for UAVs. The algorithm attempts to combine and generalize some of the past body of knowledge on the mobile robot planning problem, and highlights the increasing \emph{computational demands} and their relation to energy consumption, path, and autonomy.

Planning algorithms for mobile robots broadly are not a new concept, in that they are correlated to such topics as trajectory generation and path planning. Generally, these algorithms select an energy-optimized trajectory~\cite{mei2004energy}, by e.g., maximizing the operational time~\cite{wahab2015energy}, but in practice apply to few robots~\cite{kim2005energy}, and focus on optimizing motion control for these robots~\cite{kim2008minimum}, despite compelling evidence for the systems' energy being influenced by the computations over bare motion~\cite{mei2005case}. For UAVs specifically, rotorcrafts have equally gained research interest in terms of algorithms for energy-optimized trajectory generation~\cite{morbidi2016minimum,kreciglowa2017energy}. Furthermore, past mission planning algorithms--which include a broader concept of a mission being a set of tasks along with a motion plan--also focus on the trajectory~\cite{mei2005case,mei2006deployment}, and apply to few robots~\cite{sadrpour2013mission,sadrpour2013experimental}. Yet, computations of such systems are only expected to increase in the near future.

The proposed algorithm alters the energy consumption dynamically by means of mission-specific parameters: the Quality of Service (QoS) of the computations, and the trajectory-explicit equations (TEEs) adjustments. In the remainder of the paper, we strictly adopt the following notation.  We refer to the values of mission-specific QoS and TEEs parameters as computations and adjustments, to the constraints sets that delimit such computations and adjustments as QoS and TEEs sets, and to the current trajectory as TEE. Our goal is a mission extension by optimizing both computations and adjustments as the UAV flies and its batteries drain. First, the algorithm optimizes computations requiring the UAV to include robot operating system (ROS) nodes. Then, it optimizes adjustments--a way to alter the trajectory--and guides the UAV using a vector field~\cite{de2017guidance} that converges smoothly to such trajectory. It relies on the assumptions of the mission being \emph{periodic} and \emph{uncertain}. The periodicity is directly observed, by e.g., the UAV flying in repetitive patterns, and the uncertainty accounts for the environmental interference with e.g., a fixed-wing UAV drifting due to windy weather. It addresses the periodicity modeling the energy with Fourier analysis--being the mission periodic, we expect the energy to evolve also periodically--and the uncertainty with a state estimator. It selects the controls (computations and adjustments) using robust output feedback model predictive control (MPC).

In the spirit of reducing waste, costs, and resources, we showcase the algorithm using the problem of dynamic mission planning for a precision agriculture fixed-wing UAV. Such a scenario is often put into practice~\cite{hajjaj2014review} with ground mobile robots used for harvesting~\cite{qingchun2012study,dong2011development, de2011design, aljanobi2010setup, li2008analysis, edan2000robotic}, and UAVs for preventing damage and ensuring better crop quality~\cite{puri2017agriculture, daponte2019review}. The mission consist of a UAV flying in ellipses shifted in time, detecting obstacles using a convolutional neural network (CNN), and informing grounded mobile robots employed for future harvesting--a monitoring mission optimized for the craft's dynamics. The algorithm plans the mission controlling the processing rate and the length of the semi-major and -minor axis. Data indicates a potential extension of up to 13 minutes over an hour by merely switching to the lowest computations.

The remainder of the paper is organized as follows. The overview of dynamic mission planning is set in Section~\ref{sec:prob}, along with a suitable model for the position and energy. The algorithm that uses the model and solves the mobile robot dynamic mission planning problem is proposed in Section~\ref{sec:algo}. Section~\ref{sec:experimental} presents the result and showcase the performance. The paper finishes with some conclusions in Section~\ref{sec:conclusion}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Mission Planning Overview}
\label{sec:prob}

Let the mission be a generic continuous twice differentiable TEE $\varphi$ and a set of $\sigma$ tasks $\psi_1,\dots,\psi_{\sigma}$. Moreover, let $t_f$ be the mission final time, $[\,\cdot\,]$ the set $\{1,2,\dots,\,\cdot\,\}$, and $\underline{\,\cdot\,},\overline{\,\cdot\,}$ the upper and lower bound of $\,\cdot\,$.

\begin{defn}[Mission]\label{def:mission}
  At a time instant $k\in[0,t_f)\subseteq\mathbb{R}_{\geq 0}$, the mission is defined as the ordered list
  \begin{equation}\label{eq:mission}\begin{split}
    \mathcal{M}_k:=\{(\varphi,\psi_1,...,\psi_\sigma)\mid\exists&\,\,\varphi\in\mathbb{C}_k,\,\\&\psi_i\in\mathbb{S}_{k,i}\,\forall i\in[\sigma]\},
  \end{split}\end{equation}
  where $\mathbb{C}_k:=[\underline{c}_k,\overline{c}_k]\subseteq\mathbb{R}$ is the TEEs set, and $\mathbb{S}_{k,i}:=[\underline{s}_{k,i},\overline{s}_{k,i}]\subseteq\mathbb{Z}_{\geq 0}$ the $i$-th task QoS set.
\end{defn}

The overall plan is the union of all the missions. If for simplicity the system is sampled discrete-time
\begin{equation}
  \mathcal{M}:=\bigcup_{i\in[t_f]}{\mathcal{M}_i},
\end{equation}
the algorithm inputs $\mathcal{M}$ and outputs the position and the instantaneous energy consumption, while it adapts the controls--an action performed evolving the mission state.

\subsection{Mission state}
\label{sec:model}

The mission state is the UAV's position in space and the energy evolution in time. Despite we show a linear relation between the instantaneous energy and the energy evolution, the two are different. We show after the main results how such approach indeed allowed us variability in terms of the systems behaving periodically, piece-wise periodically, or merely linearly with sporadic periodicity.

Consider the position $\mathbf{p}\in\mathbb{R}^2$ of a UAV flying at an assigned altitude $h\in\mathbb{R}_{>0}$ w.r.t. some inertial navigation frame $\mathcal{O}_W$, the set
\begin{equation}\label{eq:area}
  \mathcal{P}_k:=\{\mathbf{p}_k\mid\varphi_k(\mathbf{p}_k,c_{k,1},\dots,c_{k,\rho})\in\mathbb{C}_k\},
\end{equation}
delimits the area where the $k$-th TEE $\varphi_k:\mathbb{R}^2\times\mathbb{R}^{\rho}\rightarrow\mathbb{R}$ is free to evolve using $\rho$ adjustments $\mathbf{c}_k:=c_{k,1},...,c_{k,\rho}$, being the TEE satisfied for all the approaching points $\varphi_k\rightarrow\mathbb{C}_k$.

The algorithm uses the concept to select the adjustments s.t. $\varphi_k(\mathbf{p}_k,\mathbf{c}_k^0)$ has the highest energy value. It guides the UAV to the new position $\mathbf{p}_{k+1}$ using the vector field of $\varPhi:=\varphi_k(\mathbf{p}_k,\mathbf{c}_k^0)$, deriving the direction to follow--the desired velocity vector
\begin{equation}\label{eq:pd}
  \dot{\mathbf{p}}_d(\mathbf{p}_k):=E\nabla\varPhi-k_e\varPhi\nabla\varPhi,\,\,\,E=\begin{bmatrix}
    0&1\\-1&0
  \end{bmatrix},
\end{equation}
where $\nabla\varPhi\in\mathbb{R}^2$ is the gradient, $E$ specifies the tracking direction, and $k_e\in\mathbb{R}_{\geq 0}$ the gain to adjusts the speed of convergence. The direction the velocity vector $\dot{\mathbf{p}}_d$ is pointing at is generally different from the course heading due to the atmospheric interference.

The algorithm models the energy using a state $\mathbf{q}\in\mathbb{R}^j$ derived from Fourier analysis (the meaning of $j$ is clarified to the reader shortly) and decompose such evolution in the energy due to the trajectory, and computations--an approach adapted from our earlier work on computational energy analysis~\cite{seewald2019coarse, seewald2019component}, and energy estimation of a fixed-wing UAV~\cite{seewald2020mechanical}. 

\subsection{Energy evolution due to trajectory}
\label{sec:energy-model}

Let us consider a Fourier series $h:\mathbb{R}_{\geq 0}\rightarrow\mathbb{R}$ of an arbitrary order $r\in\mathbb{Z}_{\geq 0}$ for the purpose of energy modeling of the mission
\begin{equation}\label{eq:fourier}
  h(t)=\sum_{n=0}^{r}{a_n\cos{\frac{nt}{\xi}}+b_n\sin{\frac{nt}{\xi}}},
\end{equation}
where $\xi\in\mathbb{R}$ is the characteristic time, and $a_n, b_n\in\mathbb{R}$ the Fourier series coefficients.

Suppose uncertainty in the form of $\mathbf{w}_k\in\mathbb{R}^j,v_k\in\mathbb{R}$ accounting for the unknown state and output is not present. The non-linear model in Equation~(\ref{eq:fourier}) can be expressed using an equivalent linear discrete time-invariant state-space model
\begin{equation}\label{eq:state-perf}\begin{cases}
  \mathbf{q}_{k+1}&=A\mathbf{q}_{k}+B\mathbf{u}_{k}+\mathbf{w}_k\\
  y_k&=C\mathbf{q}_k+v_k
\end{cases},\end{equation}
where $y_k\in\mathbb{R}_{\geq 0}$ is the instantaneous energy consumption. We prove formally in the Theorem~\ref{thm:state-vs-energy} the instantaneous energy being obtained as a linear combination of the state. The state $\mathbf{q}$ mimics the original Fourier series coefficients
\begin{equation}\label{eq:state-details}\begin{split}
  \mathbf{q}_k&=\left[\begin{array}{cccccc}
    \alpha_0 & \alpha_1 & \beta_1 & \cdots & \alpha_r & \beta_r
  \end{array}\right]^T,\\
  A&=\left[\begin{array}{cccc}
    1&    &       &  \\
     & A_1&       &  \\
     &    & \ddots&  \\
     &    &       & A_r 
  \end{array}\right],\,A_n=\begin{bmatrix}0 & \frac{n}{\xi} \\ -\frac{n^2}{\xi^2} & 0\end{bmatrix},\\
  C&=\left[\begin{array}{cccccc}
    1 & 1 & 0 & \cdots & 1 & 0
  \end{array}\right],
\end{split}\end{equation}
where $\mathbf{q}_k\in\mathbb{R}^j$ given $j:=2r+1$, $A\in\mathbb{R}^{j\times j}$ is the state transmission matrix, and $C\in\mathbb{R}^j$ is the output matrix. In matrix $A$, the first value is one, $A_n$ is later on the diagonal, and zero in the remainder.

The control $\mathbf{u}$ along with the input matrix
\begin{equation}\label{eq:state-control}\begin{split}  
  \mathbf{u}_k&=\begin{bmatrix}g(\mathbf{s}_k)-g(\mathbf{s}_{k-1}) & \mathbf{c}_k-\mathbf{c}_{k-1}\end{bmatrix}^T,\\
  B&=\left[\begin{array}{cccc}
    1& \omega_{k,1}& \cdots& \omega_{k,\rho}  \\
     &            0&       &  \\
     &             & \ddots&  \\
     &             &       & 0
  \end{array}\right],
\end{split}\end{equation}
where $\mathbf{s}_k$ is defined in Subsection~\ref{sec:computations-model}, $\mathbf{u}_k\in\mathbb{R}^l$ is the control given $l:=1+\rho$, $\mathbf{u}_{0}=\begin{bmatrix}0 & \cdots & 0\end{bmatrix}^T$ and $B\in\mathbb{R}^{j\times l}$. Moreover, the first item is one, while the others on the first row are gain factors $\omega_{k}\in\mathbb{R}$, quantifying the contribution of a given adjustment to the instantaneous energy. 

The energy evolution analysis necessitates the following realistic assumption.
\begin{assm}[Energy evelution periodicity]\label{assm:periodic} 
Given two time instants $k_1,k_2\in[t_f]$ s.t. $k_1>k_2$ and a constant value $n\in\mathbb{R}_{> 0}$, there exist an arbitrary constant displacement $e\in\mathbb{R}$
\begin{equation}
  \abs{y_{k}-y_{k+n}}= e\,\,\,\forall k\in[k_1,k_2].
\end{equation}
\end{assm}

Physically, the time evolution of the instantaneous energy consumption is assumed periodic, in the sense that it presents repetitive patterns. We show in Section~\ref{sec:experimental} the assumption being eased in practice to a set $\mathbb{E}\subset\mathbb{R}$, or omitted under specific conditions.

Equation~(\ref{eq:state-control}) accounts for the energy due to the computations. The energy due to the adjustments is merely a linear combination of the gain factor and the adjustment. Nevertheless, the change updates the path which will hence affect the reading from the sensors and adjust the energy evolution accordingly. The linearity simulates how a variation affects the energy, for instance, a decrement in the adjustment radius of a circle when the TEE is a circle, adds a negative contribution, thus simulates the lowering of instantaneous energy consumption.

In the case of the system behaving ideally (i.e., with no uncertainty), we expect a set of states evolving accordingly to their outputs. Such observation is summarized in the following Lemma.

\begin{lem}\label{lem:state-vs-energy}
  Suppose the system of Equation~(\ref{eq:state-perf}) evolves with no uncertainty ($\mathbf{w}=\mathbf{0},v=0$) and Assumption~\ref{assm:periodic} holds. Given two time instants $k_1,k_2\in[t_f]$
  \begin{equation}
    \|\mathbf{q}_{k_1}\|\geq\|\mathbf{q}_{k_2}\|\iff y_{k_1}\geq y_{k_2}.
  \end{equation}
\end{lem}
\begin{proof}
  \begin{center}\vspace{.2cm}``\emph{The easy proof is trivial and is left as an exercise to the reader :P}''\vspace{.6cm}\end{center}
\end{proof}

\subsection{Energy evolution due to computations}
\label{sec:computations-model}

The energy cost of the computations is assessed using \powprof{}, an open-source modeling tool presented in our previous work~\cite{seewald2019coarse}, that measures software configurations empirically and builds an energy model. Specifically, the tool builds a linear interpolation, one per each task. It requires the user to implement the mission as a ROS system with one or more ROS nodes changing the computational load by node-specific ROS parameters. A way to simulate the change of the computations.

The mission $\mathcal{M}$ contains a set of ordered lists with $\sigma$ tasks each (recall Definition~\ref{def:mission}). These tasks are in fact simulated by $\sigma$ ROS nodes $\Psi(\mathbf{s}_k):=\left(\psi_1(s_{k,1}),\dots,\psi_\sigma(s_{k,\sigma})\right)$. Let us define the computations
\begin{equation}\label{eq:qos-def}
  \mathbf{s}_k:=\left\{s_{k,1},\dots ,s_{k,\sigma}\mid s_i\in\mathbb{S}_{k,i}\,\forall i\in[\sigma]\right\},
\end{equation}
where $s_{k,i}:\mathbb{Z}_{\geq 0}\rightarrow\mathbb{Z}_{\geq 0}$ returns the $i$-th computation, and $\mathbf{s}_k\in\mathbb{Z}_{\geq 0}^\sigma$ the set of $\sigma$ computations at time $k$.

Let us further define $g:\mathbb{Z}_{\geq 0}\times\mathbb{Z}_{\geq 0}\rightarrow\mathbb{R}_{\geq 0}$ as the instantaneous energy value obtained interrogating \powprof{}. The instantaneous computational energy component can be defined
\begin{equation}\label{eq:energy-comp}\begin{split}
  y_k^c:&=g\left(\text{QoS}_{k,0},\dots,\text{QoS}_{k,\sigma-1}\right)=g\left(\mathbf{s}_{k}\right).\\
\end{split}\end{equation}



\begin{center}\vspace{.2cm}---\emph{from here on work in progress}---\vspace{.6cm}\end{center}

\section{Algorithm}
\label{sec:algo}

%The main goal of the algorithm is to find an optimal control action $\mathbf{u}^0$ for the current state $\hat{\mathbf{q}}$--estimated from sensors' measurements--from the optimal control law $\mathbf{u}^0=:\kappa(\hat{\mathbf{q}})$. This is achieved by solving online a finite horizon optimal control problem by the hand of a modification of a model predictive control (MPC) algorithm~\cite{rawlings2017model}.

Given mission starting point $\mathcal{M}_0$, the algorithm selects the $\mathbf{s}_k$ and $\mathbf{c}_k$ (computations and adjustments) and produce a valid state evolution
\begin{equation}\begin{split}
  \mathbf{u}:=\{(\mathbf{p}_k,\mathbf{c}_k,\mathbf{s}_k)\mid&(\varphi(\mathbf{p}_k,\mathbf{c}_k),\Psi(\mathbf{s_k}))\in\mathcal{M}_k\Longrightarrow\\
  &(\varphi(\mathbf{p}_{k+1},\mathbf{c}_{k+1}),\Psi(\mathbf{s}_{k+1}))\in\mathcal{M}_{k+1}\\
  {}&\forall k\in[t_f-1]\}.
\end{split}\end{equation} 

Let us proof formally an important finding from Section~\ref{sec:model} extensively used in the algorithm.

% [Ad:] I am actually not entirely sure if the thm should be here (and if it makes sense). Aka proving formally that what we do is actually what we expect; so perhaps it does make sense but I would like your opinion before spending time on the demonstrations... Same for the lemma.
% [Ad:] And here I had the doubt if to place the thm just straight after the lemma or here. I places it here as this is actually the main contribution -> the energy model working. Does it make any sense?

\begin{thm}\label{thm:state-vs-energy}
  Consider a continuously differentiable function $\varphi_k:\mathbb{R}^2\times\mathbb{R}^{\sigma}\rightarrow\mathbb{R}$ at a time instant $k\in\mathbb{T}$.
  Assume Assumption~\ref{assm:periodic} holds, the robots is free to move in $\mathcal{P}$ defined in~(\ref{eq:area}), and is following $\varphi$ with the direction $\dot{\mathbf{p}}_d$ defined in~\ref{eq:pd}. Likewise in Lemma~\ref{lem:state-vs-energy}, the model behaves ideally. 
  Then, the instantaneous energy consumption is a linear combination of the state
  \begin{equation}
    y_k=C\mathbf{q}_k=\sum_{n=0}^r{\alpha_n},
  \end{equation}
  where $\alpha_n\in\mathbf{q}_k$ are the $r+1$ state's components at $k$ with $r$ being a preassigned arbitrary order from~(\ref{eq:fourier}), and $C$ is described in Equation~(\ref{eq:state-details}).
\end{thm}
\begin{proof}
  *\\
\end{proof}









\subsection{State estimation}
\label{sec:state-est}

As the environment uncertainty and measurement error evolve in a normal distribution, we use a Kalman filter~\cite{stengel1994optimal, simon2006optimal} for the purpose of state estimation. 

The prediction is done using
\begin{subequations}\label{eq:kalman-pred}\begin{align}
  \hat{\mathbf{q}}_{k+1}^-&=A\hat{\mathbf{q}}_{k}+B\mathbf{u}_k,\label{eq:kalman-pred1}\\
  P_{k+1}^-&=AP_kA^T+Q,\label{eq:kalman-pred2}
\end{align}\end{subequations}
where $\hat{\mathbf{q}}_k^-,\hat{\mathbf{q}}_k\in\mathbb{R}^j$ depicts the estimate of the state before and after measurement (or simply estimate), and $P_k,P_k^-\in\mathbb{R}^{j\times j}$ the error covariance matrix (i.e., the variance of the estimate). 

The estimation of the state and the update of the predicted output is done using
\begin{subequations}\label{eq:kalman-est}\begin{align}
  K_k&=(CP_{k+1}^-C^T+R)^{-1}(P_{k+1}^-C^T),\\
  \hat{\mathbf{q}}_{k+1}&=\hat{\mathbf{q}}_{k+1}^-+K_k(y_k^s+y_k^c-C\hat{\mathbf{q}}_{k+1}^-),\label{eq:kalman-est2}\\
  P_{k+1}&=(I-K_kC)P_{k+1}^-,\\
  \hat{y}_k&=C\hat{\mathbf{q}}_{k+1},\label{eq:kalman-est4}
\end{align}
\end{subequations}
where $K_k\in\mathbb{R}^j$ is the gain of the Kalman filter, and $I$ the identity matrix. $y_k^s,y_k^c$ are the instantaneous energy readings: $y_k^s\in\mathbb{R}_{\geq 0}$ the robot sensor, i.e., the energy due to the trajectory, and $y_k^c$ the energy of a given software configuration described in Equation~(\ref{eq:energy-comp}). The noise covariance matrices $Q\in\mathbb{R}^{j\times j},R\in\mathbb{R}$ indicates the uncertainty and measurement error covariance respectively, and $\hat{y}_k\in\mathbb{R}_{\geq 0}$ is the estimated energy.

Equations~(\ref{eq:kalman-pred}--\ref{eq:kalman-est}) converge to the predicted energy evolution as follows. An initial guess of the values $\hat{\mathbf{q}}_0,P_0$ is derived empirically from collected data. It is worth considering that an appropriate guess of these parameters allows the algorithm to converge to the desired energy evolution in a shorter amount of time. The tuning parameters $Q,R$ are also derived from the collected data, and may differ due to i.e., different sensors used to measure the instantaneous energy consumption, or different atmospheric conditions accounting for the process noise.

At time $k=0$, the initial estimate before measurement of the state and of the error covariance matrix is updated in Equation~(\ref{eq:kalman-pred1})~and~(\ref{eq:kalman-pred2}) respectively. The value of $\hat{\mathbf{q}}_1^-$ is then used in Equation~(\ref{eq:kalman-est2}) to estimate the current state along with the data from the sensor $y_0$ (e.g., the energy sensor of the flight controller of the fixed-wing craft), where the sensor noise covariance matrix $R$ accounts for the amount of uncertainty in the measurement. The estimated output $\hat{y}_0$ is then obtained from Equation~(\ref{eq:kalman-est4}). The algorithm is iterative. At time $k=1$ the values $\hat{\mathbf{q}}_1,P_1$ computed at previous step are used to estimate the values $\hat{\mathbf{q}}_2,P_2,$ and $y_1$.

\subsection{Optimal control action}

*

\subsection{Deployment algorithm}

*

%%%%%%%%%%%%%%%%%%%%
\section{Evaluation}
\label{sec:experimental}

*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Conclusion and Future Work}
\label{sec:conclusion}

*

\bibliographystyle{IEEEtran}
\bibliography{\jobname} 
\vspace{0.1ex}

\newpage

\end{document}
